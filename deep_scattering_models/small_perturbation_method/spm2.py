# -*- coding: utf-8 -*-
"""SPM2.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1OkUWinSTPbm2T6PupQF4MAjk5VOE_Y7O
"""

import numpy as np
from numpy import pi, sqrt, sin, cos, exp, log10, array, real, conj

## Par√°metros Globales ##

#onda incidente
def kiz(k0,thi): 
    return k0*cos(thi)

def kix(k0,thi,phi):
    return k0*sin(thi)*cos(phi)

def kiy(k0,thi,phi):
    return k0*sin(thi)*sin(phi)

def kir(k0,thi):
    return k0*sin(thi)

#onda dispersada
def kx(k0,th,ph):
    return k0*sin(th)*cos(ph)

def ky(k0,th,ph):
    return k0*sin(th)*sin(ph)

def k0z(k0,th):
    return k0*cos(th)
    
#ondas transmitidas
def k1z(k0,th,ep1):
    return k0*sqrt(ep1-sin(th)**2)

def k2z(k0,th,ep2):
    return k0*sqrt(ep2-sin(th)**2)

##kz interface plana

def k1zi(k0,thi,ep1):
    return k0*sqrt(ep1-sin(thi)**2)

def k2zi(k0,thi,ep2):
    return k0*sqrt(ep2-sin(thi)**2)

#componente tangencial
def kr(k0,th):
    return k0*sin(th)

#-------------------------------------------#

"""<h1>AMPLITUDES DE LAS ONDAS DISPERSADAS/TRANSMITIDAS </h1>
<br>
<br>

**Coeficientes a: asociados a las ondas dispersadas en +z en la region 0**
<br>
<br>

**coeficientes bb: asociados a las ondas dispersadas en +z en la region 1**
<br>
<br>

**coeficientes b: asociados a las ondas dispersadas en -z en la region 1**
<br>
<br>

**coeficientes c: asociados a las ondas dispersadas en -z en la region 2**

<h2> Coeficientes de orden cero </h2>
"""

import numpy as np
from numpy import pi, sqrt, sin, cos, exp, log10, array, real, conj

## CANAL HH ##

def a0HH(k0,thi,ep1,ep2,d):
    return (-1j*k1zi(k0,thi,ep1)*(k2zi(k0,thi,ep2) - kiz(k0,thi))*cos(d*k1zi(k0,thi,ep1)) + (-k1zi(k0,thi,ep1)**2 + k2zi(k0,thi,ep2)*kiz(k0,thi))*sin(d*k1zi(k0,thi,ep1)))/(1j*k1zi(k0,thi,ep1)*(k2zi(k0,thi,ep2) + kiz(k0,thi))*cos(d*k1zi(k0,thi,ep1)) + (k1zi(k0,thi,ep1)**2 + k2zi(k0,thi,ep2)*kiz(k0,thi))*sin(d*k1zi(k0,thi,ep1)))

def bb0HH(k0,thi,ep1,ep2,d):
    return (2*kiz(k0,thi))/(-k1zi(k0,thi,ep1) + kiz(k0,thi) + ((k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2))*(k1zi(k0,thi,ep1) + kiz(k0,thi)))/(exp(2*1j*d*k1zi(k0,thi,ep1))*(k1zi(k0,thi,ep1) - k2zi(k0,thi,ep2))))

def b0HH(k0,thi,ep1,ep2,d):
    return (-2*(k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2))*kiz(k0,thi))/(exp(2*1j*d*k1zi(k0,thi,ep1))*(k1zi(k0,thi,ep1) - k2zi(k0,thi,ep2))*(k1zi(k0,thi,ep1) - kiz(k0,thi)) - (k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2))*(k1zi(k0,thi,ep1) + kiz(k0,thi)))

def c0HH(k0,thi,ep1,ep2,d):
    return (-4*exp(1j*d*(k1zi(k0,thi,ep1) - k2zi(k0,thi,ep2)))*k1zi(k0,thi,ep1)*kiz(k0,thi))/(exp(2*1j*d*k1zi(k0,thi,ep1))*(k1zi(k0,thi,ep1) - k2zi(k0,thi,ep2))*(k1zi(k0,thi,ep1) - kiz(k0,thi)) - (k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2))*(k1zi(k0,thi,ep1) + kiz(k0,thi)))

## CANAL VH ##

a0VH = 0
bb0VH = 0
b0VH = 0
c0VH = 0

## CANAL VV ##
def a0VV(k0,thi,ep1,ep2,d):
    return (-1j*k1zi(k0,thi,ep1)*ep1*(k2zi(k0,thi,ep2) - kiz(k0,thi)*ep2)*cos(d*k1zi(k0,thi,ep1)) + (k2zi(k0,thi,ep2)*kiz(k0,thi)*ep1**2 - k1zi(k0,thi,ep1)**2*ep2)*sin(d*k1zi(k0,thi,ep1)))/(1j*k1zi(k0,thi,ep1)*ep1*(k2zi(k0,thi,ep2) + kiz(k0,thi)*ep2)*cos(d*k1zi(k0,thi,ep1)) + (k2zi(k0,thi,ep2)*kiz(k0,thi)*ep1**2 + k1zi(k0,thi,ep1)**2*ep2)*sin(d*k1zi(k0,thi,ep1)))

def bb0VV(k0,thi,ep1,ep2,d):
    return (2*exp(2*1j*d*k1zi(k0,thi,ep1))*kiz(k0,thi)*sqrt(ep1)*(k2zi(k0,thi,ep2)*ep1 - k1zi(k0,thi,ep1)*ep2))/(exp(2*1j*d*k1zi(k0,thi,ep1))*(k1zi(k0,thi,ep1) - kiz(k0,thi)*ep1)*(-(k2zi(k0,thi,ep2)*ep1) + k1zi(k0,thi,ep1)*ep2) - (k1zi(k0,thi,ep1) + kiz(k0,thi)*ep1)*(k2zi(k0,thi,ep2)*ep1 + k1zi(k0,thi,ep1)*ep2))


def b0VV(k0,thi,ep1,ep2,d):
    return (-2*kiz(k0,thi)*sqrt(ep1)*(k2zi(k0,thi,ep2)*ep1 + k1zi(k0,thi,ep1)*ep2))/(exp(2*1j*d*k1zi(k0,thi,ep1))*(k1zi(k0,thi,ep1) - kiz(k0,thi)*ep1)*(-(k2zi(k0,thi,ep2)*ep1) + k1zi(k0,thi,ep1)*ep2) - (k1zi(k0,thi,ep1) + kiz(k0,thi)*ep1)*(k2zi(k0,thi,ep2)*ep1 + k1zi(k0,thi,ep1)*ep2))

def c0VV(k0,thi,ep1,ep2,d):
    return (-4*exp(1j*d*(k1zi(k0,thi,ep1) - k2zi(k0,thi,ep2)))*k1zi(k0,thi,ep1)*kiz(k0,thi)*ep1*sqrt(ep2))/(exp(2*1j*d*k1zi(k0,thi,ep1))*(k1zi(k0,thi,ep1) - kiz(k0,thi)*ep1)*(-(k2zi(k0,thi,ep2)*ep1) + k1zi(k0,thi,ep1)*ep2) - (k1zi(k0,thi,ep1) + kiz(k0,thi)*ep1)*(k2zi(k0,thi,ep2)*ep1 + k1zi(k0,thi,ep1)*ep2))

## CANAL HV ##

a0HV = 0
bb0HV = 0
b0HV = 0
c0HV = 0

"""<h2> Coeficientes de orden uno </h2>
<br>
<br>

**Coeficientes aF1: asociados a las ondas dispersadas en +z en la region 0 y proporcionales
a el espectro de rugosisdad de la primera capa**
<br>
<br>

**Coeficientes aF2: asociados a las ondas dispersadas en +z en la region 0 y proporcionales
a el espectro de rugosisdad de la segunda capa**
<br>
<br>

**Lo mismo vale para los coeficientes 'bb', 'b' y 'c'**
"""

## CANAL HH ##
# AMPLITUD ONDA DISPERSADA #
def a1HHF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return 1j*((kr(k0,th)*((1 + a0HH(k0,thi,ep1,ep2,d))*exp(1j*d*(2*k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*(kix(k0,thi,phi)*(kiz(k0,thi)**2 + kir(k0,thi)**2)*kx(k0,th,ph) + kiy(k0,thi,phi)*kiz(k0,thi)**2*ky(k0,th,ph) - kir(k0,thi)**2*(kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2))*sqrt(ep1)*(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) - k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2))-\
            exp(1j*d*(2*k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*((-1 + a0HH(k0,thi,ep1,ep2,d))*k1z(k0,th,ep1)*kiz(k0,thi)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + bb0HH(k0,thi,ep1,ep2,d)*(k1z(k0,th,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) - k1z(k0,th,ep1)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*(kix(k0,thi,phi)*kx(k0,th,ph) - kx(k0,th,ph)**2 + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph))) + \
            b0HH(k0,thi,ep1,ep2,d)*(k1z(k0,th,ep1)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*(kix(k0,thi,phi)*kx(k0,th,ph) - kx(k0,th,ph)**2 + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph))))*sqrt(ep1)*(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) - k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2)) + \
            exp(1j*d*k1zi(k0,thi,ep1))*((1 + a0HH(k0,thi,ep1,ep2,d))*(kix(k0,thi,phi)*(kiz(k0,thi)**2 + kir(k0,thi)**2)*kx(k0,th,ph) + kiy(k0,thi,phi)*kiz(k0,thi)**2*ky(k0,th,ph) - kir(k0,thi)**2*(kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2))*sqrt(ep1) - \
            (-((-1 + a0HH(k0,thi,ep1,ep2,d))*k1z(k0,th,ep1)*kiz(k0,thi)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))) + bb0HH(k0,thi,ep1,ep2,d)*(k1z(k0,th,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + k1z(k0,th,ep1)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*(kix(k0,thi,phi)*kx(k0,th,ph) - kx(k0,th,ph)**2 + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph))) + \
            b0HH(k0,thi,ep1,ep2,d)*(-(k1z(k0,th,ep1)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))) + k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*(kix(k0,thi,phi)*kx(k0,th,ph) - kx(k0,th,ph)**2 + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph))))*sqrt(ep1))*(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2))))/\
            (exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(k0z(k0,th)*sqrt(ep1)*((1 + exp(2*1j*d*k1z(k0,th,ep1)))*k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) - (-1 + exp(2*1j*d*k1z(k0,th,ep1)))*k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2)) + \
            k1z(k0,th,ep1)*sqrt(ep1)*(-((-1 + exp(2*1j*d*k1z(k0,th,ep1)))*k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2)) + (1 + exp(2*1j*d*k1z(k0,th,ep1)))*k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2))))) 

def a1HHF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*(kr(k0,th)*(2*b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + 2*k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*sqrt(ep1)*(k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1)*sqrt(ep2) - k1zi(k0,thi,ep1)*k2z(k0,th,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1)*sqrt(ep2) + \
            kir(k0,thi)**2*(kix(k0,thi,phi)*kx(k0,th,ph) - kx(k0,th,ph)**2 + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph))*sqrt(ep1)*sqrt(ep2)) + 2*bb0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*sqrt(ep1)*\
            (k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1)*sqrt(ep2) + k1zi(k0,thi,ep1)*k2z(k0,th,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1)*sqrt(ep2) + kir(k0,thi)**2*(kix(k0,thi,phi)*kx(k0,th,ph) - kx(k0,th,ph)**2 + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph))*sqrt(ep1)*sqrt(ep2)) - \
            2*c0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*k1z(k0,th,ep1)*(-(k2z(k0,th,ep2)*k2zi(k0,thi,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))) + k2zi(k0,thi,ep2)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*(kix(k0,thi,phi)*kx(k0,th,ph) - kx(k0,th,ph)**2 + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*ep1*sqrt(ep2)))/\
            (exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(k0z(k0,th)*sqrt(ep1)*((1 + exp(2*1j*d*k1z(k0,th,ep1)))*k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) - (-1 + exp(2*1j*d*k1z(k0,th,ep1)))*k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2)) + \
            k1z(k0,th,ep1)*sqrt(ep1)*(-((-1 + exp(2*1j*d*k1z(k0,th,ep1)))*k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2)) + (1 + exp(2*1j*d*k1z(k0,th,ep1)))*k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2))))

# COEFICIENTES AUXILIARES CANAL HH #
def bb1HHF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return 1j*(exp(1j*d*(k1z(k0,th,ep1) - k1zi(k0,thi,ep1)))*kr(k0,th)*(-(exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*((-1 + a0HH(k0,thi,ep1,ep2,d))*k0z(k0,th)*kiz(k0,thi)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) - (1 + a0HH(k0,thi,ep1,ep2,d))*(kix(k0,thi,phi)*(kiz(k0,thi)**2 + kir(k0,thi)**2)*kx(k0,th,ph) + kiy(k0,thi,phi)*kiz(k0,thi)**2*ky(k0,th,ph) - kir(k0,thi)**2*(kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2)))*sqrt(ep1)*\
            (k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) - k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2))) - bb0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*\
            (k0z(k0,th)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1) - (k1z(k0,th,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1))*(-(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2)) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2)) + \
            b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*(k0z(k0,th)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1) + (k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1))*\
            (-(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2)) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2))))/\
            (kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th)*sqrt(ep1) - k1z(k0,th,ep1)*sqrt(ep1))*(-(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2)) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2)) - \
            (k0z(k0,th)*sqrt(ep1) + k1z(k0,th,ep1)*sqrt(ep1))*(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2))))  
 
def bb1HHF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return 1j*(exp(1j*d*(k1z(k0,th,ep1) - k1zi(k0,thi,ep1)))*kr(k0,th)*(-(b0HH(k0,thi,ep1,ep2,d)*exp(2*1j*d*k1zi(k0,thi,ep1))*(k0z(k0,th)*sqrt(ep1) + k1z(k0,th,ep1)*sqrt(ep1))*\
            (k1zi(k0,thi,ep1)*k2z(k0,th,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1)*sqrt(ep2) - (k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1)*sqrt(ep2))) + \
            bb0HH(k0,thi,ep1,ep2,d)*(k0z(k0,th)*sqrt(ep1) + k1z(k0,th,ep1)*sqrt(ep1))*(k1zi(k0,thi,ep1)*k2z(k0,th,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1)*sqrt(ep2) + (k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1)*sqrt(ep2)) + \
            c0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*(k2z(k0,th,ep2)*k2zi(k0,thi,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) - k2zi(k0,thi,ep2)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*(-(kix(k0,thi,phi)*kx(k0,th,ph)) + kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2))*(k0z(k0,th)*sqrt(ep1) + k1z(k0,th,ep1)*sqrt(ep1))*sqrt(ep1)*sqrt(ep2)))/\
            (kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th)*sqrt(ep1) - k1z(k0,th,ep1)*sqrt(ep1))*(-(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2)) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2)) - \
            (k0z(k0,th)*sqrt(ep1) + k1z(k0,th,ep1)*sqrt(ep1))*(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2))))     

def b1HHF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return 1j*(kr(k0,th)*(bb0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*(k0z(k0,th)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1) - (k1z(k0,th,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1))*\
            (k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2)) - b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*\
            (k0z(k0,th)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1) + (k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1))*(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2)) - \
            exp(1j*d*k1zi(k0,thi,ep1))*((-1 + a0HH(k0,thi,ep1,ep2,d))*k0z(k0,th)*kiz(k0,thi)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) - (1 + a0HH(k0,thi,ep1,ep2,d))*(kix(k0,thi,phi)*(kiz(k0,thi)**2 + kir(k0,thi)**2)*kx(k0,th,ph) + kiy(k0,thi,phi)*kiz(k0,thi)**2*ky(k0,th,ph) - kir(k0,thi)**2*(kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2)))*sqrt(ep1)*\
            (k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2))))/\
            (exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th)*sqrt(ep1) - k1z(k0,th,ep1)*sqrt(ep1))*(-(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2)) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2)) - \
            (k0z(k0,th)*sqrt(ep1) + k1z(k0,th,ep1)*sqrt(ep1))*(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2)))) 

def b1HHF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return 1j*(kr(k0,th)*(b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + 2*k1zi(k0,thi,ep1)))*(k0z(k0,th)*sqrt(ep1) - k1z(k0,th,ep1)*sqrt(ep1))*(k1zi(k0,thi,ep1)*k2z(k0,th,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1)*sqrt(ep2) - \
            (k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1)*sqrt(ep2)) - \
            bb0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k1z(k0,th,ep1))*(k0z(k0,th)*sqrt(ep1) - k1z(k0,th,ep1)*sqrt(ep1))*(k1zi(k0,thi,ep1)*k2z(k0,th,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1)*sqrt(ep2) + (k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1)*sqrt(ep2)) + \
            c0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*(-(k2z(k0,th,ep2)*k2zi(k0,thi,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))) + k2zi(k0,thi,ep2)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*(k0z(k0,th)*sqrt(ep1) - k1z(k0,th,ep1)*sqrt(ep1))*sqrt(ep1)*sqrt(ep2)))/\
            (exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th)*sqrt(ep1) - k1z(k0,th,ep1)*sqrt(ep1))*(-(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2)) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2)) - \
            (k0z(k0,th)*sqrt(ep1) + k1z(k0,th,ep1)*sqrt(ep1))*(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2))))

def c1HHF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return 1j*(kr(k0,th)*(-2*bb0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*(-(k0z(k0,th)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1)) + (k1z(k0,th,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1))*sqrt(ep1)*sqrt(ep2) + \
            2*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*(-((-1 + a0HH(k0,thi,ep1,ep2,d))*k0z(k0,th)*kiz(k0,thi)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))) + (1 + a0HH(k0,thi,ep1,ep2,d))*(kix(k0,thi,phi)*(kiz(k0,thi)**2 + kir(k0,thi)**2)*kx(k0,th,ph) + kiy(k0,thi,phi)*kiz(k0,thi)**2*ky(k0,th,ph) - kir(k0,thi)**2*(kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2)))*ep1*sqrt(ep2) - \
            2*b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + 2*k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*(k0z(k0,th)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1) + (k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1))*sqrt(ep1)*sqrt(ep2)*cos(d*k1zi(k0,thi,ep1)) + \
            2*1j*b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + 2*k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*(k0z(k0,th)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1) + (k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1))*sqrt(ep1)*sqrt(ep2)*sin(d*k1zi(k0,thi,ep1))))/\
            (exp(1j*d*(k1zi(k0,thi,ep1) + k2z(k0,th,ep2)))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th)*sqrt(ep1) - k1z(k0,th,ep1)*sqrt(ep1))*(-(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2)) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2)) - \
            (k0z(k0,th)*sqrt(ep1) + k1z(k0,th,ep1)*sqrt(ep1))*(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2))))

def c1HHF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return 1j*(kr(k0,th)*(bb0HH(k0,thi,ep1,ep2,d)*exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*(-(k0z(k0,th)*sqrt(ep1)) + k1z(k0,th,ep1)*sqrt(ep1))*sqrt(ep1)*sqrt(ep2) - \
            bb0HH(k0,thi,ep1,ep2,d)*(k1z(k0,th,ep1)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) - k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*(-(kix(k0,thi,phi)*kx(k0,th,ph)) + kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2))*(k0z(k0,th)*sqrt(ep1) + k1z(k0,th,ep1)*sqrt(ep1))*sqrt(ep1)*sqrt(ep2) + \
            2*b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + 2*k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*(k0z(k0,th)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1) + (k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1))*sqrt(ep1)*sqrt(ep2)*cos(d*k1z(k0,th,ep1)) - \
            2*1j*b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + 2*k1zi(k0,thi,ep1)))*(k1z(k0,th,ep1)**2*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1) + k0z(k0,th)*(k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1))*sqrt(ep1)*sqrt(ep2)*\
            sin(d*k1z(k0,th,ep1)) + 2*1j*c0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*(1j*k1z(k0,th,ep1)*ep1*(k0z(k0,th)*k2zi(k0,thi,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep2) + (k2zi(k0,thi,ep2)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep2))*\
            cos(d*k1z(k0,th,ep1)) + (k1z(k0,th,ep1)**2*k2zi(k0,thi,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1*sqrt(ep2) + k0z(k0,th)*(k2zi(k0,thi,ep2)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*ep1*sqrt(ep2))*sin(d*k1z(k0,th,ep1)))))/\
            (exp(1j*d*(k1zi(k0,thi,ep1) + k2z(k0,th,ep2)))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th)*sqrt(ep1) - k1z(k0,th,ep1)*sqrt(ep1))*(-(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2)) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2)) - 
            (k0z(k0,th)*sqrt(ep1) + k1z(k0,th,ep1)*sqrt(ep1))*(k1z(k0,th,ep1)*sqrt(ep1)*sqrt(ep2) + k2z(k0,th,ep2)*sqrt(ep1)*sqrt(ep2))))

## CANAL VH ##
# AMPLITUD ONDA DISPERSADA #
def a1VHF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*(((kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*(exp(1j*d*(2*k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*(-((1 + a0HH(k0,thi,ep1,ep2,d))*k1z(k0,th,ep1)*(kiz(k0,thi)**2 + kir(k0,thi)**2)*sqrt(ep1)) + k1z(k0,th,ep1)*(bb0HH(k0,thi,ep1,ep2,d)*k1z(k0,th,ep1)**2 + b0HH(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**2 + (bb0HH(k0,thi,ep1,ep2,d) + b0HH(k0,thi,ep1,ep2,d))*kir(k0,thi)**2)*sqrt(ep1) + \
            (-bb0HH(k0,thi,ep1,ep2,d) + b0HH(k0,thi,ep1,ep2,d))*k1zi(k0,thi,ep1) + (-1 + a0HH(k0,thi,ep1,ep2,d))*kiz(k0,thi))*ep1**1.5)*sqrt(ep2)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) + \
            exp(1j*d*k1zi(k0,thi,ep1))*((1 + a0HH(k0,thi,ep1,ep2,d))*k1z(k0,th,ep1)*(kiz(k0,thi)**2 + kir(k0,thi)**2)*sqrt(ep1) - k1z(k0,th,ep1)*(bb0HH(k0,thi,ep1,ep2,d)*k1z(k0,th,ep1)**2 + b0HH(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**2 + (bb0HH(k0,thi,ep1,ep2,d) + b0HH(k0,thi,ep1,ep2,d))*kir(k0,thi)**2)*sqrt(ep1) + ((-bb0HH(k0,thi,ep1,ep2,d) + b0HH(k0,thi,ep1,ep2,d))*k1zi(k0,thi,ep1) + (-1 + a0HH(k0,thi,ep1,ep2,d))*kiz(k0,thi))*ep1**1.5)*sqrt(ep2)*\
            (k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))/(exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*sqrt(ep1)*sqrt(ep2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) +\
            k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 +k1z(k0,th,ep1)*ep2)))


def a1VHF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*((kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*(-2*c0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*k1z(k0,th,ep1)*ep1**1.5*sqrt(ep2)*(k2z(k0,th,ep2)*(k2zi(k0,thi,ep2)**2 + kir(k0,thi)**2) - k2zi(k0,thi,ep2)*ep2) + \
            2*b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + 2*k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*ep1*sqrt(ep2)*(k2z(k0,th,ep2)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2)*sqrt(ep1) - k1zi(k0,thi,ep1)*sqrt(ep1)*ep2) + \
            2*bb0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*ep1*sqrt(ep2)*(k2z(k0,th,ep2)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2)*sqrt(ep1) + k1zi(k0,thi,ep1)*sqrt(ep1)*ep2)))/\
            (exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*sqrt(ep1)*sqrt(ep2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))


# COEFICIENTES AUXILIARES CANAL VH #
def bb1VHF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return 1j*(exp(1j*d*(k1z(k0,th,ep1) - k1zi(k0,thi,ep1)))*(kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*(bb0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*(k1zi(k0,thi,ep1)*sqrt(ep1) - k0z(k0,th)*(k1z(k0,th,ep1)**2 + kir(k0,thi)**2)*sqrt(ep1))*sqrt(ep2)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + \
            b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*(k1zi(k0,thi,ep1)*sqrt(ep1) + k0z(k0,th)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2)*sqrt(ep1))*sqrt(ep2)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) + \
            exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*((-1 + a0HH(k0,thi,ep1,ep2,d))*kiz(k0,thi) - (1 + a0HH(k0,thi,ep1,ep2,d))*k0z(k0,th)*(kiz(k0,thi)**2 + kir(k0,thi)**2))*sqrt(ep1)*sqrt(ep2)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2)))/\
            (kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*sqrt(ep2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2))) 


def bb1VHF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return 1j*(exp(1j*d*(k1z(k0,th,ep1) - k1zi(k0,thi,ep1)))*(kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*(-(c0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*sqrt(ep1)*(k1z(k0,th,ep1) + k0z(k0,th)*ep1)*sqrt(ep2)*(k2z(k0,th,ep2)*(k2zi(k0,thi,ep2)**2 + kir(k0,thi)**2) - k2zi(k0,thi,ep2)*ep2)) + \
            b0HH(k0,thi,ep1,ep2,d)*exp(2*1j*d*k1zi(k0,thi,ep1))*(k1z(k0,th,ep1) + k0z(k0,th)*ep1)*sqrt(ep2)*(k2z(k0,th,ep2)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2)*sqrt(ep1) - k1zi(k0,thi,ep1)*sqrt(ep1)*ep2) + bb0HH(k0,thi,ep1,ep2,d)*(k1z(k0,th,ep1) + k0z(k0,th)*ep1)*sqrt(ep2)*(k2z(k0,th,ep2)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2)*sqrt(ep1) + k1zi(k0,thi,ep1)*sqrt(ep1)*ep2)))/\
            (kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*sqrt(ep2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

def b1VHF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return  -1j*(((kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*(bb0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*(k1zi(k0,thi,ep1)*sqrt(ep1) - k0z(k0,th)*(k1z(k0,th,ep1)**2 + kir(k0,thi)**2)*sqrt(ep1))*sqrt(ep2)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2) - \
            b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*(k1zi(k0,thi,ep1)*sqrt(ep1) + k0z(k0,th)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2)*sqrt(ep1))*sqrt(ep2)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2) - \
            exp(1j*d*k1zi(k0,thi,ep1))*((-1 + a0HH(k0,thi,ep1,ep2,d))*kiz(k0,thi) - (1 + a0HH(k0,thi,ep1,ep2,d))*k0z(k0,th)*(kiz(k0,thi)**2 + kir(k0,thi)**2))*sqrt(ep1)*sqrt(ep2)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))/\
            (exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*sqrt(ep2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))) 

def b1VHF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*((kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*(c0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*sqrt(ep1)*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*sqrt(ep2)*(k2z(k0,th,ep2)*(k2zi(k0,thi,ep2)**2 + kir(k0,thi)**2) - k2zi(k0,thi,ep2)*ep2) + \
            b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + 2*k1zi(k0,thi,ep1)))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*sqrt(ep2)*(-(k2z(k0,th,ep2)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2)*sqrt(ep1)) + k1zi(k0,thi,ep1)*sqrt(ep1)*ep2) - \
            bb0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*sqrt(ep2)*(k2z(k0,th,ep2)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2)*sqrt(ep1) + k1zi(k0,thi,ep1)*sqrt(ep1)*ep2)))/\
            (exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*sqrt(ep2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

def c1VHF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*(((kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*(-2*bb0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*(-(k1zi(k0,thi,ep1)*sqrt(ep1)) + k0z(k0,th)*(k1z(k0,th,ep1)**2 + kir(k0,thi)**2)*sqrt(ep1))*ep1*sqrt(ep2) - \
            2*b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*(k1zi(k0,thi,ep1)*sqrt(ep1) + k0z(k0,th)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2)*sqrt(ep1))*ep1*sqrt(ep2) - \
            2*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*((-1 + a0HH(k0,thi,ep1,ep2,d))*kiz(k0,thi) - (1 + a0HH(k0,thi,ep1,ep2,d))*k0z(k0,th)*(kiz(k0,thi)**2 + kir(k0,thi)**2))*ep1**1.5*sqrt(ep2)))/\
            (exp(1j*d*(k1zi(k0,thi,ep1) + k2z(k0,th,ep2)))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*sqrt(ep1)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))) 

def c1VHF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*((kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*(c0HH(k0,thi,ep1,ep2,d)*sqrt(ep1)*(exp(1j*d*(2*k1z(k0,th,ep1) + k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k1z(k0,th,ep1)*(k2zi(k0,thi,ep2)**2 + kir(k0,thi)**2)*sqrt(ep2) - k2zi(k0,thi,ep2)*ep1*sqrt(ep2)) - \
            exp(1j*d*(k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*(k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k1z(k0,th,ep1)*(k2zi(k0,thi,ep2)**2 + kir(k0,thi)**2)*sqrt(ep2) + k2zi(k0,thi,ep2)*ep1*sqrt(ep2))) - \
            b0HH(k0,thi,ep1,ep2,d)*exp(2*1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*sqrt(ep1)*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k1z(k0,th,ep1)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) - k1zi(k0,thi,ep1)*ep1)*sqrt(ep2) + bb0HH(k0,thi,ep1,ep2,d)*sqrt(ep1)*(k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k1z(k0,th,ep1)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) - k1zi(k0,thi,ep1)*ep1)*sqrt(ep2) + \
            bb0HH(k0,thi,ep1,ep2,d)*exp(2*1j*d*k1z(k0,th,ep1))*sqrt(ep1)*(-k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k1z(k0,th,ep1)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) + k1zi(k0,thi,ep1)*ep1)*sqrt(ep2) + b0HH(k0,thi,ep1,ep2,d)*exp(2*1j*d*k1zi(k0,thi,ep1))*sqrt(ep1)*(k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k1z(k0,th,ep1)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) + k1zi(k0,thi,ep1)*ep1)*sqrt(ep2)))/\
            (exp(1j*d*(k1zi(k0,thi,ep1) + k2z(k0,th,ep2)))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*sqrt(ep1)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

## CANAL VV ##
# AMPLITUD ONDA DISPERSADA #
def a1VVF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return 1j*(kr(k0,th)*(exp(1j*d*(2*k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*(-(k1z(k0,th,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*((-1 + a0VV(k0,thi,ep1,ep2,d))*kiz(k0,thi) + b0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)*sqrt(ep1))) + bb0VV(k0,thi,ep1,ep2,d)*k1z(k0,th,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1) - \
            (bb0VV(k0,thi,ep1,ep2,d) + b0VV(k0,thi,ep1,ep2,d))*(k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1) + (1 + a0VV(k0,thi,ep1,ep2,d))*(kix(k0,thi,phi)*(kiz(k0,thi)**2 + kir(k0,thi)**2)*kx(k0,th,ph) + kiy(k0,thi,phi)*kiz(k0,thi)**2*ky(k0,th,ph) - kir(k0,thi)**2*(kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2))*ep1)\
            *(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - exp(1j*d*k1zi(k0,thi,ep1))*(-(k1z(k0,th,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*((-1 + a0VV(k0,thi,ep1,ep2,d))*kiz(k0,thi) + b0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)*sqrt(ep1))) + bb0VV(k0,thi,ep1,ep2,d)*k1z(k0,th,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*sqrt(ep1) + \
            (bb0VV(k0,thi,ep1,ep2,d) + b0VV(k0,thi,ep1,ep2,d))*(k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1) - (1 + a0VV(k0,thi,ep1,ep2,d))*(kix(k0,thi,phi)*(kiz(k0,thi)**2 + kir(k0,thi)**2)*kx(k0,th,ph) + kiy(k0,thi,phi)*kiz(k0,thi)**2*ky(k0,th,ph) - kir(k0,thi)**2*(kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2))*ep1)\
            *(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))/(exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2))) 

def a1VVF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return 1j*(kr(k0,th)*(-2*c0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*k1z(k0,th,ep1)*(-(k2z(k0,th,ep2)*k2zi(k0,thi,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))) + k2zi(k0,thi,ep2)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*ep1*sqrt(ep2) + \
            2*b0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + 2*k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*sqrt(ep1)*(-(k1zi(k0,thi,ep1)*k2z(k0,th,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1) + k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep2 + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph))*ep2) + \
            2*bb0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*sqrt(ep1)*(k1zi(k0,thi,ep1)*k2z(k0,th,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1 + k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep2 + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph))*ep2)))/\
            (exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

# COEFICIENTES AUXILIARES CANAL VV #
def bb1VVF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*((exp(1j*d*(k1z(k0,th,ep1) - k1zi(k0,thi,ep1)))*kr(k0,th)*(exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*((-1 + a0VV(k0,thi,ep1,ep2,d))*k0z(k0,th)*kiz(k0,thi)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) - (1 + a0VV(k0,thi,ep1,ep2,d))*(kix(k0,thi,phi)*(kiz(k0,thi)**2 + kir(k0,thi)**2)*kx(k0,th,ph) + kiy(k0,thi,phi)*kiz(k0,thi)**2*ky(k0,th,ph) - kir(k0,thi)**2*(kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2)))*sqrt(ep1)*\
            (k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + bb0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*(k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)) - k0z(k0,th)*k1z(k0,th,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + \
            b0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*(k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)) + k0z(k0,th)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2)))/\
            (kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))) 

def bb1VVF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*(exp(1j*d*(k1z(k0,th,ep1) - k1zi(k0,thi,ep1)))*kr(k0,th)*(c0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*(k2z(k0,th,ep2)*k2zi(k0,thi,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) - k2zi(k0,thi,ep2)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*(-(kix(k0,thi,phi)*kx(k0,th,ph)) + kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2))*sqrt(ep1)*(k1z(k0,th,ep1) + k0z(k0,th)*ep1)*\
            sqrt(ep2) - b0VV(k0,thi,ep1,ep2,d)*exp(2*1j*d*k1zi(k0,thi,ep1))*(k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k1zi(k0,thi,ep1)*k2z(k0,th,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1 - (k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*ep2) + \
            bb0VV(k0,thi,ep1,ep2,d)*(k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k1zi(k0,thi,ep1)*k2z(k0,th,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1 + (k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*ep2)))/\
            (kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

def b1VVF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return  -1j*((kr(k0,th)*(-(exp(1j*d*k1zi(k0,thi,ep1))*((-1 + a0VV(k0,thi,ep1,ep2,d))*k0z(k0,th)*kiz(k0,thi)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) - (1 + a0VV(k0,thi,ep1,ep2,d))*(kix(k0,thi,phi)*(kiz(k0,thi)**2 + kir(k0,thi)**2)*kx(k0,th,ph) + kiy(k0,thi,phi)*kiz(k0,thi)**2*ky(k0,th,ph) - kir(k0,thi)**2*(kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2)))*sqrt(ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2))-\
            bb0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*(k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)) - k0z(k0,th)*k1z(k0,th,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2) -\
             b0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*(k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)) + k0z(k0,th)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))/\
            (exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))) 

def b1VVF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*(kr(k0,th)*(-(c0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*(-(k2z(k0,th,ep2)*k2zi(k0,thi,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))) + k2zi(k0,thi,ep2)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*sqrt(ep1)*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*sqrt(ep2))+\
             b0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + 2*k1zi(k0,thi,ep1)))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k1zi(k0,thi,ep1)*k2z(k0,th,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1) + k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep2 + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph))*ep2) +\
             bb0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k1zi(k0,thi,ep1)*k2z(k0,th,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1 + k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep2 + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph))*ep2)))/\
             (exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))\


def c1VVF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*(kr(k0,th)*(2*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*((-1 + a0VV(k0,thi,ep1,ep2,d))*k0z(k0,th)*kiz(k0,thi)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) - (1 + a0VV(k0,thi,ep1,ep2,d))*(kix(k0,thi,phi)*(kiz(k0,thi)**2 + kir(k0,thi)**2)*kx(k0,th,ph) + kiy(k0,thi,phi)*kiz(k0,thi)**2*ky(k0,th,ph) - kir(k0,thi)**2*(kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2)))*ep1*sqrt(ep2) - \
             2*bb0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*sqrt(ep1)*(-(k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))) + kir(k0,thi)**2*(-(kix(k0,thi,phi)*kx(k0,th,ph)) + kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2) + k0z(k0,th)*k1z(k0,th,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1)*sqrt(ep2) + \
             2*b0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + 2*k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*sqrt(ep1)*(k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)) + k0z(k0,th)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1)*sqrt(ep2)*cos(d*k1zi(k0,thi,ep1)) - \
             2*1j*b0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + 2*k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*sqrt(ep1)*(k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)) + k0z(k0,th)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1)*sqrt(ep2)*sin(d*k1zi(k0,thi,ep1))))/\
             (exp(1j*d*(k1zi(k0,thi,ep1) + k2z(k0,th,ep2)))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))


def c1VVF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return  1j*(kr(k0,th)*(bb0VV(k0,thi,ep1,ep2,d)*sqrt(ep1)*(-(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)) + \
             (k1z(k0,th,ep1)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) - k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*(-(kix(k0,thi,phi)*kx(k0,th,ph)) + kx(k0,th,ph)**2 - kiy(k0,thi,phi)*ky(k0,th,ph) + ky(k0,th,ph)**2))*(k1z(k0,th,ep1) + k0z(k0,th)*ep1))*sqrt(ep2) - \
             2*b0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + 2*k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*sqrt(ep1)*(k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)) + k0z(k0,th)*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep1)*sqrt(ep2)*cos(d*k1z(k0,th,ep1)) + \
             2*1j*b0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + 2*k1zi(k0,thi,ep1)))*sqrt(ep1)*(k1z(k0,th,ep1)**2*k1zi(k0,thi,ep1)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + k0z(k0,th)*(k1zi(k0,thi,ep1)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*ep1)*sqrt(ep2)*sin(d*k1z(k0,th,ep1)) + \
             2*c0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*(k1z(k0,th,ep1)*ep1*(k2zi(k0,thi,ep2)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)) + k0z(k0,th)*k2zi(k0,thi,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep2)*cos(d*k1z(k0,th,ep1)) - \
             1j*(k0z(k0,th)*(k2zi(k0,thi,ep2)**2*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph)) + kir(k0,thi)**2*((kix(k0,thi,phi) - kx(k0,th,ph))*kx(k0,th,ph) + (kiy(k0,thi,phi) - ky(k0,th,ph))*ky(k0,th,ph)))*ep1**2 + k1z(k0,th,ep1)**2*k2zi(k0,thi,ep2)*(kix(k0,thi,phi)*kx(k0,th,ph) + kiy(k0,thi,phi)*ky(k0,th,ph))*ep2)*sin(d*k1z(k0,th,ep1)))))/\
            (exp(1j*d*(k1zi(k0,thi,ep1) + k2z(k0,th,ep2)))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 - k1z(k0,th,ep1)*ep2) + (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

## CANAL HV ##
# AMPLITUD ONDA DISPERSADA #
def a1HVF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*(((kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*(2*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*ep1*(-((bb0VV(k0,thi,ep1,ep2,d) + b0VV(k0,thi,ep1,ep2,d))*k2z(k0,th,ep2)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2)) + (kiz(k0,thi)*(-1 + a0VV(k0,thi,ep1,ep2,d) + (1 + a0VV(k0,thi,ep1,ep2,d))*k2z(k0,th,ep2)*kiz(k0,thi))+(1 + a0VV(k0,thi,ep1,ep2,d))*k2z(k0,th,ep2)*kir(k0,thi)**2)*sqrt(ep1) + \
            (-(bb0VV(k0,thi,ep1,ep2,d)*k1z(k0,th,ep1)) + b0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1))*ep1)*sqrt(ep2)*cos(d*k1z(k0,th,ep1)) + 2*1j*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*ep1*\
            ((bb0VV(k0,thi,ep1,ep2,d)+b0VV(k0,thi,ep1,ep2,d))*k1z(k0,th,ep1)**2*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) - ((-1 + a0VV(k0,thi,ep1,ep2,d))*k2z(k0,th,ep2)*kiz(k0,thi) + (1 + a0VV(k0,thi,ep1,ep2,d))*k1z(k0,th,ep1)**2*(kiz(k0,thi)**2 + kir(k0,thi)**2))*sqrt(ep1) + (bb0VV(k0,thi,ep1,ep2,d)*k1z(k0,th,ep1) - b0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1))*k2z(k0,th,ep2)*ep1)*sqrt(ep2)*sin(d*k1z(k0,th,ep1))))/\
            (exp(1j*d*k1zi(k0,thi,ep1))*(exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*ep1**1.5*sqrt(ep2)))

def a1HVF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*((kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*(-2*c0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*k1z(k0,th,ep1)*ep1**1.5*(k2z(k0,th,ep2)*(k2zi(k0,thi,ep2)**2 + kir(k0,thi)**2) - k2zi(k0,thi,ep2)*ep2) + \
            2*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*ep1*((bb0VV(k0,thi,ep1,ep2,d) + b0VV(k0,thi,ep1,ep2,d))*k2z(k0,th,ep2)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) + (bb0VV(k0,thi,ep1,ep2,d) - b0VV(k0,thi,ep1,ep2,d))*k1zi(k0,thi,ep1)*ep1)*sqrt(ep2)*cos(d*k1zi(k0,thi,ep1)) - \
            2*1j*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*ep1*((bb0VV(k0,thi,ep1,ep2,d) - b0VV(k0,thi,ep1,ep2,d))*k2z(k0,th,ep2)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) + (bb0VV(k0,thi,ep1,ep2,d) + b0VV(k0,thi,ep1,ep2,d))*k1zi(k0,thi,ep1)*ep1)*sqrt(ep2)*sin(d*k1zi(k0,thi,ep1))))/\
            (exp(1j*d*k1zi(k0,thi,ep1))*(exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*ep1**1.5*sqrt(ep2))

# COEFICIENTES AUXILIARES CANAL HV #

def bb1HVF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*((exp(1j*d*(k1z(k0,th,ep1) - k1zi(k0,thi,ep1)) + 1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*(k1z(k0,th,ep1) - k2z(k0,th,ep2))*(kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*\
             ((bb0VV(k0,thi,ep1,ep2,d) + b0VV(k0,thi,ep1,ep2,d))*k0z(k0,th)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) + (-1 + a0VV(k0,thi,ep1,ep2,d))*kiz(k0,thi)*sqrt(ep1) - (1 + a0VV(k0,thi,ep1,ep2,d))*k0z(k0,th)*(kiz(k0,thi)**2 + kir(k0,thi)**2)*sqrt(ep1) + (-(bb0VV(k0,thi,ep1,ep2,d)*k1z(k0,th,ep1)) + b0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1))*ep1))/\
             ((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*sqrt(ep1))) 

def bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*(exp(1j*d*(k1z(k0,th,ep1) - k1zi(k0,thi,ep1)))*(kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*((k0z(k0,th) + k1z(k0,th,ep1))*sqrt(ep1)*(bb0VV(k0,thi,ep1,ep2,d)*k2z(k0,th,ep2)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) + bb0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)*ep1 + b0VV(k0,thi,ep1,ep2,d)*exp(2*1j*d*k1zi(k0,thi,ep1))*(k2z(k0,th,ep2)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) - k1zi(k0,thi,ep1)*ep1))*ep2 + \
            c0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*(k0z(k0,th) + k1z(k0,th,ep1))*ep1*sqrt(ep2)*(-(k2z(k0,th,ep2)*(k2zi(k0,thi,ep2)**2 + kir(k0,thi)**2)) + k2zi(k0,thi,ep2)*ep2)))/((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*ep1*ep2)

def b1HVF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*(((kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*(-(exp(1j*d*k1zi(k0,thi,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2))*(kiz(k0,thi)*(1 - a0VV(k0,thi,ep1,ep2,d) + (1 + a0VV(k0,thi,ep1,ep2,d))*k0z(k0,th)*kiz(k0,thi)) + (1 + a0VV(k0,thi,ep1,ep2,d))*k0z(k0,th)*kir(k0,thi)**2)*ep1*ep2) + \
            bb0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2))*sqrt(ep1)*(k0z(k0,th)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) - k1z(k0,th,ep1)*ep1)*ep2 + b0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2))*sqrt(ep1)*(k0z(k0,th)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) + k1zi(k0,thi,ep1)*ep1)*ep2))/\
            (exp(1j*d*k1zi(k0,thi,ep1))*(exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*ep1*ep2)) 

def b1HVF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return -1j*((kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*(b0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1) + 1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*(-k0z(k0,th) + k1z(k0,th,ep1))*sqrt(ep1)*(k2z(k0,th,ep2)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) - k1zi(k0,thi,ep1)*ep1)*ep2 + \
             bb0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k1z(k0,th,ep1))*(-k0z(k0,th) + k1z(k0,th,ep1))*sqrt(ep1)*(k2z(k0,th,ep2)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) + k1zi(k0,thi,ep1)*ep1)*ep2 + c0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*(-k0z(k0,th) + k1z(k0,th,ep1))*ep1*sqrt(ep2)*(-(k2z(k0,th,ep2)*(k2zi(k0,thi,ep2)**2 + kir(k0,thi)**2)) + k2zi(k0,thi,ep2)*ep2)))/\
             (exp(1j*d*k1zi(k0,thi,ep1))*(exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*ep1*ep2)

def c1HVF1(k0,thi,phi,th,ph,ep1,ep2,d):
    return 1j*((kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*(2*bb0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*sqrt(ep1)*(-(k0z(k0,th)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2)) + k1z(k0,th,ep1)*ep1)*sqrt(ep2) - \
            2*exp(1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*k1z(k0,th,ep1)*sqrt(ep1)*(b0VV(k0,thi,ep1,ep2,d)*k0z(k0,th)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) + (-1 + a0VV(k0,thi,ep1,ep2,d))*kiz(k0,thi)*sqrt(ep1) - (1 + a0VV(k0,thi,ep1,ep2,d))*k0z(k0,th)*(kiz(k0,thi)**2 + kir(k0,thi)**2)*sqrt(ep1) + b0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)*ep1)*sqrt(ep2)))/\
            (exp(1j*d*(k1zi(k0,thi,ep1) + k2z(k0,th,ep2)))*(exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*ep1*sqrt(ep2)) 

def c1HVF2(k0,thi,phi,th,ph,ep1,ep2,d):
    return  1j*((kiy(k0,thi,phi)*kx(k0,th,ph) - kix(k0,thi,phi)*ky(k0,th,ph))*kr(k0,th)*(-(b0VV(k0,thi,ep1,ep2,d)*exp(2*1j*d*(k1z(k0,th,ep1) + k1zi(k0,thi,ep1)))*(-k0z(k0,th) + k1z(k0,th,ep1))*sqrt(ep1)*(k1z(k0,th,ep1)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) - k1zi(k0,thi,ep1)*ep1)*sqrt(ep2)) + \
             b0VV(k0,thi,ep1,ep2,d)*exp(2*1j*d*k1zi(k0,thi,ep1))*(k0z(k0,th) + k1z(k0,th,ep1))*sqrt(ep1)*(k1z(k0,th,ep1)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) + k1zi(k0,thi,ep1)*ep1)*sqrt(ep2) + \
             bb0VV(k0,thi,ep1,ep2,d)*sqrt(ep1)*((k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) - k1zi(k0,thi,ep1)*ep1) + exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1)*(k1zi(k0,thi,ep1)**2 + kir(k0,thi)**2) + k1zi(k0,thi,ep1)*ep1))*sqrt(ep2) + \
             c0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*ep1*(exp(2*1j*d*k1z(k0,th,ep1))*(-k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1)*(k2zi(k0,thi,ep2)**2 + kir(k0,thi)**2) - k2zi(k0,thi,ep2)*ep2) - (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1)*(k2zi(k0,thi,ep2)**2 + kir(k0,thi)**2) + k2zi(k0,thi,ep2)*ep2))))/\
             (exp(1j*d*(k1zi(k0,thi,ep1) + k2z(k0,th,ep2)))*(exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*kir(k0,thi)*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*ep1*sqrt(ep2))

"""**8-oct-2019: a primer orden da ex√°ctamente el gr√°fico de Johnson 1999 para una sola interface**

<h2> Coeficientes de orden dos </h2>
<br>

**Est√°n definidos en funci√≥n de [sx,sy] que son variables auxiliares que deben ser integradas en (-Inf ; Inf)**
"""

def sr(sx,sy):
    return sqrt(sx**2+sy**2)

def s0z(k0,sx,sy):
    return sqrt(k0**2-sx**2-sy**2+0j)

def s1z(k0,sx,sy,ep1):
    return sqrt(ep1*k0**2-sx**2-sy**2+0j)

# # para recuperar una sola capa
# def s1z(k0,sx,sy,ep1):
#     return 0*sqrt(ep1*k0**2-sx**2-sy**2+0j)

def s2z(k0,sx,sy,ep2):
    return sqrt(ep2*k0**2-sx**2-sy**2+0j)

"""**MODO TE**"""

# coeficientes que dependen solo de los de orden cero --> no dependen de (sx,sy)
def L01TE(k0,thi,phi,ep1,ep2,d):
    return (-((b0HH(k0,thi,ep1,ep2,d) + bb0HH(k0,thi,ep1,ep2,d))*k1zi(k0,thi,ep1)**2*kix(k0,thi,phi))+(1 + a0HH(k0,thi,ep1,ep2,d))*kix(k0,thi,phi)*kiz(k0,thi)**2)/(2*kir(k0,thi))

def L02TE(k0,thi,phi,ep1,ep2,d):
    return -(b0HH(k0,thi,ep1,ep2,d) *k1zi(k0,thi,ep1)**2*kiy(k0,thi,phi))/(2.*kir(k0,thi))-(bb0HH(k0,thi,ep1,ep2,d) *k1zi(k0,thi,ep1)**2*kiy(k0,thi,phi))/(2*kir(k0,thi))+(kiy(k0,thi,phi)*kiz(k0,thi)**2)/(2.*kir(k0,thi))+(a0HH(k0,thi,ep1,ep2,d) *kiy(k0,thi,phi)*kiz(k0,thi)**2)/(2.*kir(k0,thi))

def L03TE(k0,thi,phi,ep1,ep2,d):
    return (kiy(k0,thi,phi)*kiz(k0,thi)**3)/(2*k0*kir(k0,thi))-(a0HH(k0,thi,ep1,ep2,d) *kiy(k0,thi,phi)*kiz(k0,thi)**3)/(2*k0*kir(k0,thi))-(b0HH(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**3*kiy(k0,thi,phi)*sqrt(ep1))/(2.*k0*kir(k0,thi))+(bb0HH(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**3*kiy(k0,thi,phi)*sqrt(ep1))/(2*k0*kir(k0,thi))

def L04TE(k0,thi,phi,ep1,ep2,d):
    return -(kix(k0,thi,phi)*kiz(k0,thi)**3)/(2*k0*kir(k0,thi))+(a0HH(k0,thi,ep1,ep2,d) *kix(k0,thi,phi)*kiz(k0,thi)**3)/(2*k0*kir(k0,thi)) + (b0HH(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**3*kix(k0,thi,phi)*sqrt(ep1))/(2*k0*kir(k0,thi))-(bb0HH(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**3*kix(k0,thi,phi)*sqrt(ep1))/(2*k0*kir(k0,thi))

def L05TE(k0,thi,phi,ep1,ep2,d):
    return (bb0HH(k0,thi,ep1,ep2,d) *k1zi(k0,thi,ep1)**2*kix(k0,thi,phi))/(2*exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)) + (b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*k1zi(k0,thi,ep1)**2*kix(k0,thi,phi))/(2*kir(k0,thi))-(c0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k2zi(k0,thi,ep2))*k2zi(k0,thi,ep2)**2*kix(k0,thi,phi))/(2*kir(k0,thi))

def L06TE(k0,thi,phi,ep1,ep2,d):
    return (bb0HH(k0,thi,ep1,ep2,d) *k1zi(k0,thi,ep1)**2*kiy(k0,thi,phi))/(2*exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi))+(b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*k1zi(k0,thi,ep1)**2*kiy(k0,thi,phi))/(2*kir(k0,thi))-(c0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k2zi(k0,thi,ep2))*k2zi(k0,thi,ep2)**2*kiy(k0,thi,phi))/(2*kir(k0,thi))

def L07TE(k0,thi,phi,ep1,ep2,d):
    return -((bb0HH(k0,thi,ep1,ep2,d) *k1zi(k0,thi,ep1)**3*kiy(k0,thi,phi))/(exp(1j*d*k1zi(k0,thi,ep1))*k0*kir(k0,thi)))+(b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*k1zi(k0,thi,ep1)**3*kiy(k0,thi,phi))/(k0*kir(k0,thi))-(c0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k2zi(k0,thi,ep2))*k2zi(k0,thi,ep2)**3*kiy(k0,thi,phi))/(k0*kir(k0,thi))

def L08TE(k0,thi,phi,ep1,ep2,d):
    return (bb0HH(k0,thi,ep1,ep2,d) *k1zi(k0,thi,ep1)**3*kix(k0,thi,phi))/(exp(1j*d*k1zi(k0,thi,ep1))*k0*kir(k0,thi))-(b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*k1zi(k0,thi,ep1)**3*kix(k0,thi,phi))/(k0*kir(k0,thi))+(c0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k2zi(k0,thi,ep2))*k2zi(k0,thi,ep2)**3*kix(k0,thi,phi))/(k0*kir(k0,thi))

##-----------------##

# coeficientes que dependen de sx,sy y deben ser integrados #

L11TE = 0

#--F1
def Y1TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -1j*s0z(k0,sx,sy)*((a1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (a1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s0z(k0,sx,sy)*sy)/(k0*sr(sx,sy))) + (1j*a1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 - 1j*s1z(k0,sx,sy,ep1)*((b1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (b1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))+\
            1j*s1z(k0,sx,sy,ep1)*((bb1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (bb1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1))) - (1j*b1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep1)) - (1j*bb1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep1))

def q1TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L11TE + Y1TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#--F2
def Y1TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -1j*s0z(k0,sx,sy)*((a1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (a1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s0z(k0,sx,sy)*sy)/(k0*sr(sx,sy))) + (1j*a1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 - 1j*s1z(k0,sx,sy,ep1)*((b1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (b1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))+\
            1j*s1z(k0,sx,sy,ep1)*((bb1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (bb1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1))) - (1j*b1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep1)) - (1j*bb1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep1))

def q1TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L11TE + Y1TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d):
#----

L12TE = 0

#--F1
def Y2TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -1j*s0z(k0,sx,sy)*(-((a1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s0z(k0,sx,sy)*sx)/(k0*sr(sx,sy))) + (a1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy)) - (1j*a1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph)-sx)*sr(sx,sy))/k0 - 1j*s1z(k0,sx,sy,ep1)*((b1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (b1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))+\
            1j*s1z(k0,sx,sy,ep1)*((bb1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (bb1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1))) + (1j*b1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep1)) + (1j*bb1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep1))

def q2TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L12TE + Y2TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#--F2
def Y2TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -1j*s0z(k0,sx,sy)*(-((a1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s0z(k0,sx,sy)*sx)/(k0*sr(sx,sy))) + (a1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy)) - (1j*a1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph)-sx)*sr(sx,sy))/k0 - 1j*s1z(k0,sx,sy,ep1)*((b1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (b1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))+\
            1j*s1z(k0,sx,sy,ep1)*((bb1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (bb1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1))) + (1j*b1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep1)) + (1j*bb1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep1))

def q2TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L12TE + Y2TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#----

def L13TE(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (b0HH(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)*kir(k0,thi)*(ky(k0,th,ph)-sy))/k0-(bb0HH(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)*kir(k0,thi)*(ky(k0,th,ph) - sy))/k0 - (kiz(k0,thi)*kir(k0,thi)*(ky(k0,th,ph)-sy))/k0 + (a0HH(k0,thi,ep1,ep2,d)*kiz(k0,thi)*kir(k0,thi)*(ky(k0,th,ph) - sy))/k0

#--F1
def Y3TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -1j*s0z(k0,sx,sy)*((a1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (a1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy))) - (1j*a1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph)-sy)*sr(sx,sy))/k0 + (1j*(b1HHF1(k0,thi,phi,th,ph,ep1,ep2,d) + bb1HHF1(k0,thi,phi,th,ph,ep1,ep2,d))*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 - 1j*s1z(k0,sx,sy,ep1)*((b1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy)+\
            (b1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)+1j*s1z(k0,sx,sy,ep1)*((bb1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (bb1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)

def q3TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L13TE(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y3TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#--F2
def Y3TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -1j*s0z(k0,sx,sy)*((a1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy)-(a1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy))) - (1j*a1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph)-sy)*sr(sx,sy))/k0 + (1j*(b1HHF2(k0,thi,phi,th,ph,ep1,ep2,d) + bb1HHF2(k0,thi,phi,th,ph,ep1,ep2,d))*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 - 1j*s1z(k0,sx,sy,ep1)*((b1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (b1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)+\
            1j*s1z(k0,sx,sy,ep1)*((bb1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy)-(bb1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)

def q3TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L13TE(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y3TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#----

def L14TE(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -((b0HH(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)*kir(k0,thi)*(kx(k0,th,ph)-sx))/k0)+(bb0HH(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)*kir(k0,thi)*(kx(k0,th,ph) - sx))/k0 + (kiz(k0,thi)*kir(k0,thi)*(kx(k0,th,ph)-sx))/k0-(a0HH(k0,thi,ep1,ep2,d)*kiz(k0,thi)*kir(k0,thi)*(kx(k0,th,ph)-sx))/k0

#--F1
def Y4TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -1j*s0z(k0,sx,sy)*((a1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)) + (a1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy)) + (1j*a1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 - (1j*(b1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)+\
            bb1HHF1(k0,thi,phi,th,ph,ep1,ep2,d))*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 - 1j*s1z(k0,sx,sy,ep1)*((b1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (b1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)+\
            1j*s1z(k0,sx,sy,ep1)*((bb1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (bb1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)

def q4TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L14TE(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y4TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#--F2
def Y4TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -1j*s0z(k0,sx,sy)*((a1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)) + (a1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy)) + (1j*a1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 - (1j*(b1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)+\
            bb1HHF2(k0,thi,phi,th,ph,ep1,ep2,d))*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 - 1j*s1z(k0,sx,sy,ep1)*((b1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (b1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)+\
            1j*s1z(k0,sx,sy,ep1)*((bb1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (bb1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)

def q4TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L14TE(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y4TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#-----

L15TE = 0

#--F1
def Y5TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (b1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1))) - (1j*s1z(k0,sx,sy,ep1)*((bb1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (bb1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1))))/exp(1j*d*s1z(k0,sx,sy,ep1))+\
            (1j*(bb1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (c1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sy)/(k0*sr(sx,sy)*sqrt(ep2)))-\
            (1j*c1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep2))

def q5TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L15TE + Y5TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)


#--F2
def Y5TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (b1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1))) - (1j*s1z(k0,sx,sy,ep1)*((bb1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (bb1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1))))/exp(1j*d*s1z(k0,sx,sy,ep1))+\
            (1j*(bb1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (c1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sy)/(k0*sr(sx,sy)*sqrt(ep2)))-\
            (1j*c1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep2))

def q5TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L15TE + Y5TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#----

L16TE = 0

#--F1
def Y6TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (b1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1))) - (1j*s1z(k0,sx,sy,ep1)*((bb1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (bb1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1))))/exp(1j*d*s1z(k0,sx,sy,ep1))-\
            (1j*(bb1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (c1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sx)/(k0*sr(sx,sy)*sqrt(ep2)))+\
            (1j*c1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep2))

def q6TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L16TE + Y6TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#--F2
def Y6TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (b1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1))) - (1j*s1z(k0,sx,sy,ep1)*((bb1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (bb1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1))))/exp(1j*d*s1z(k0,sx,sy,ep1))-\
            (1j*(bb1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (c1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sx)/(k0*sr(sx,sy)*sqrt(ep2)))+\
            (1j*c1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep2))

def q6TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L16TE + Y6TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#----

def L17TE(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (bb0HH(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)*kir(k0,thi)*(ky(k0,th,ph) - sy))/(exp(1j*d*k1zi(k0,thi,ep1))*k0) - (b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*k1zi(k0,thi,ep1)*kir(k0,thi)*(ky(k0,th,ph) - sy))/k0 + (c0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k2zi(k0,thi,ep2))*k2zi(k0,thi,ep2)*kir(k0,thi)*(ky(k0,th,ph)-sy))/k0

#--F1
def Y7TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (1j*c1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 - (1j*(bb1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 + 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (b1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)-\
            (1j*s1z(k0,sx,sy,ep1)*((bb1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (bb1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1))/exp(1j*d*s1z(k0,sx,sy,ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (c1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sy)/(k0*sr(sx,sy)*sqrt(ep2)))*sqrt(ep2)


def q7TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L17TE(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y7TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#--F2
def Y7TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (1j*c1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 - (1j*(bb1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 + 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (b1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)-\
            (1j*s1z(k0,sx,sy,ep1)*((bb1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (bb1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1))/exp(1j*d*s1z(k0,sx,sy,ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (c1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sy)/(k0*sr(sx,sy)*sqrt(ep2)))*sqrt(ep2)


def q7TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L17TE(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y7TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#----

def L18TE(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -((bb0HH(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)*kir(k0,thi)*(kx(k0,th,ph) - sx))/(exp(1j*d*k1zi(k0,thi,ep1))*k0)) + (b0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*k1zi(k0,thi,ep1)*kir(k0,thi)*(kx(k0,th,ph) - sx))/k0 - (c0HH(k0,thi,ep1,ep2,d)*exp(1j*d*k2zi(k0,thi,ep2))*k2zi(k0,thi,ep2)*kir(k0,thi)*(kx(k0,th,ph) - sx))/k0

#--F1
def Y8TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (-1j*c1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 + (1j*(bb1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 + 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (b1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)-\
            (1j*s1z(k0,sx,sy,ep1)*((bb1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (bb1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1))/exp(1j*d*s1z(k0,sx,sy,ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (c1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sx)/(k0*sr(sx,sy)*sqrt(ep2)))*sqrt(ep2)

def q8TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L18TE(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y8TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#--F2
def Y8TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (-1j*c1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 + (1j*(bb1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 + 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (b1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)-\
            (1j*s1z(k0,sx,sy,ep1)*((bb1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (bb1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1))/exp(1j*d*s1z(k0,sx,sy,ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (c1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sx)/(k0*sr(sx,sy)*sqrt(ep2)))*sqrt(ep2)

def q8TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L18TE(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y8TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

"""**MODO TM**"""

# coeficientes que dependen solo de los de orden cero --> no dependen de (sx,sy)
def L01TM(k0,thi,phi,ep1,ep2,d):
    return ((b0VV(k0,thi,ep1,ep2,d)-bb0VV(k0,thi,ep1,ep2,d))*k1zi(k0,thi,ep1)**3*kiy(k0,thi,phi)+(-1 + a0VV(k0,thi,ep1,ep2,d))*kiy(k0,thi,phi)*kiz(k0,thi)**3*sqrt(ep1))/(2*k0*kir(k0,thi)*sqrt(ep1))

def L02TM(k0,thi,phi,ep1,ep2,d):
    return (kix(k0,thi,phi)*kiz(k0,thi)**3)/(2*k0*kir(k0,thi)) - (a0VV(k0,thi,ep1,ep2,d)*kix(k0,thi,phi)*kiz(k0,thi)**3)/(2*k0*kir(k0,thi)) - (b0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**3*kix(k0,thi,phi))/(2*k0*kir(k0,thi)*sqrt(ep1))+\
            (bb0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**3*kix(k0,thi,phi))/(2*k0*kir(k0,thi)*sqrt(ep1))

def L03TM(k0,thi,phi,ep1,ep2,d):
    return (kix(k0,thi,phi)*kiz(k0,thi)**2)/(2*kir(k0,thi)) + (a0VV(k0,thi,ep1,ep2,d)*kix(k0,thi,phi)*kiz(k0,thi)**2)/(2*kir(k0,thi)) - (b0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**2*kix(k0,thi,phi)*sqrt(ep1))/(2*kir(k0,thi))-\
            (bb0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**2*kix(k0,thi,phi)*sqrt(ep1))/(2*kir(k0,thi))

def L04TM(k0,thi,phi,ep1,ep2,d):
    return (kiy(k0,thi,phi)*kiz(k0,thi)**2)/(2*kir(k0,thi)) + (a0VV(k0,thi,ep1,ep2,d)*kiy(k0,thi,phi)*kiz(k0,thi)**2)/(2*kir(k0,thi)) - (b0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**2*kiy(k0,thi,phi)*sqrt(ep1))/(2*kir(k0,thi)) - \
            (bb0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**2*kiy(k0,thi,phi)*sqrt(ep1))/(2*kir(k0,thi))

def L05TM(k0,thi,phi,ep1,ep2,d):
    return (bb0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**3*kiy(k0,thi,phi))/(2*exp(1j*d*k1zi(k0,thi,ep1))*k0*kir(k0,thi)*sqrt(ep1)) - (b0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*k1zi(k0,thi,ep1)**3*kiy(k0,thi,phi))/(2*k0*kir(k0,thi)*sqrt(ep1)) +\
            (c0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k2zi(k0,thi,ep2))*k2zi(k0,thi,ep2)**3*kiy(k0,thi,phi))/(2*k0*kir(k0,thi)*sqrt(ep2))

def L06TM(k0,thi,phi,ep1,ep2,d):
    return -(bb0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**3*kix(k0,thi,phi))/(2*exp(1j*d*k1zi(k0,thi,ep1))*k0*kir(k0,thi)*sqrt(ep1)) + (b0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*k1zi(k0,thi,ep1)**3*kix(k0,thi,phi))/(2*k0*kir(k0,thi)*sqrt(ep1)) -\
            (c0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k2zi(k0,thi,ep2))*k2zi(k0,thi,ep2)**3*kix(k0,thi,phi))/(2*k0*kir(k0,thi)*sqrt(ep2))

def L07TM(k0,thi,phi,ep1,ep2,d):
    return (bb0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**2*kix(k0,thi,phi)*sqrt(ep1))/(exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)) + (b0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*k1zi(k0,thi,ep1)**2*kix(k0,thi,phi)*sqrt(ep1))/kir(k0,thi) - \
            (c0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k2zi(k0,thi,ep2))*k2zi(k0,thi,ep2)**2*kix(k0,thi,phi)*sqrt(ep2))/kir(k0,thi)

def L08TM(k0,thi,phi,ep1,ep2,d):
    return (bb0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1)**2*kiy(k0,thi,phi)*sqrt(ep1))/(exp(1j*d*k1zi(k0,thi,ep1))*kir(k0,thi)) + (b0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k1zi(k0,thi,ep1))*k1zi(k0,thi,ep1)**2*kiy(k0,thi,phi)*sqrt(ep1))/kir(k0,thi) -\
            (c0VV(k0,thi,ep1,ep2,d)*exp(1j*d*k2zi(k0,thi,ep2))*k2zi(k0,thi,ep2)**2*kiy(k0,thi,phi)*sqrt(ep2))/kir(k0,thi)

##-----------------##

# coeficientes que dependen de sx,sy y deben ser integrados #

def L11TM(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -((kir(k0,thi)*(ky(k0,th,ph) - sy)*(b0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1) - bb0VV(k0,thi,ep1,ep2,d)*k1zi(k0,thi,ep1) +\
            (-1 + a0VV(k0,thi,ep1,ep2,d))*kiz(k0,thi)*sqrt(ep1)))/(k0*sqrt(ep1)))

#--F1
def Y1TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -1j*s0z(k0,sx,sy)*((a1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (a1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s0z(k0,sx,sy)*sy)/(k0*sr(sx,sy))) + (1j*a1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 - 1j*s1z(k0,sx,sy,ep1)*((b1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (b1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))+\
            1j*s1z(k0,sx,sy,ep1)*((bb1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (bb1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1))) - (1j*b1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep1)) - (1j*bb1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep1))

def q1TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L11TM(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y1TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#--F2
def Y1TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -1j*s0z(k0,sx,sy)*((a1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (a1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s0z(k0,sx,sy)*sy)/(k0*sr(sx,sy))) + (1j*a1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 - 1j*s1z(k0,sx,sy,ep1)*((b1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (b1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))+\
            1j*s1z(k0,sx,sy,ep1)*((bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (bb1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1))) - (1j*b1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep1)) - (1j*bb1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep1))

def q1TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L11TM(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y1TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d):
#----

def L12TM(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (kir(k0,thi)*(kx(k0,th,ph) - sx)*((b0VV(k0,thi,ep1,ep2,d) - bb0VV(k0,thi,ep1,ep2,d))*k0*k1zi(k0,thi,ep1) + (-1 + a0VV(k0,thi,ep1,ep2,d))*k0*kiz(k0,thi)*sqrt(ep1)))/(k0**2*sqrt(ep1))

#--F1
def Y2TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -1j*s0z(k0,sx,sy)*(-((a1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s0z(k0,sx,sy)*sx)/(k0*sr(sx,sy))) + (a1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy)) - (1j*a1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 - 1j*s1z(k0,sx,sy,ep1)*((b1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (b1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1))) + \
           1j*s1z(k0,sx,sy,ep1)*((bb1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (bb1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1))) + (1j*b1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep1)) + (1j*bb1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep1))

def q2TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L12TM(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y2TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#--F2
def Y2TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -1j*s0z(k0,sx,sy)*(-((a1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s0z(k0,sx,sy)*sx)/(k0*sr(sx,sy))) + (a1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy)) - (1j*a1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 - 1j*s1z(k0,sx,sy,ep1)*((b1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (b1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1))) + \
           1j*s1z(k0,sx,sy,ep1)*((bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (bb1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1))) + (1j*b1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep1)) + (1j*bb1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep1))

def q2TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L12TM(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y2TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#----

L13TM = 0


#--F1
def Y3TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (1j*(b1HVF1(k0,thi,phi,th,ph,ep1,ep2,d) + bb1HVF1(k0,thi,phi,th,ph,ep1,ep2,d))*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 - 1j*s0z(k0,sx,sy)*((a1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (a1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy))) - (1j*a1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 - \
            1j*s1z(k0,sx,sy,ep1)*((b1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (b1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1) + 1j*s1z(k0,sx,sy,ep1)*((bb1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (bb1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)

def q3TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L13TM + Y3TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#--F2
def Y3TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (1j*(b1HVF2(k0,thi,phi,th,ph,ep1,ep2,d) + bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d))*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 - 1j*s0z(k0,sx,sy)*((a1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (a1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy))) - (1j*a1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 - \
            1j*s1z(k0,sx,sy,ep1)*((b1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (b1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1) + 1j*s1z(k0,sx,sy,ep1)*((bb1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)

def q3TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L13TM + Y3TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#----

L14TM = 0


#--F1
def Y4TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (-1j*(b1HVF1(k0,thi,phi,th,ph,ep1,ep2,d) + bb1HVF1(k0,thi,phi,th,ph,ep1,ep2,d))*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 - 1j*s0z(k0,sx,sy)*((a1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)) + (a1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy)) + (1j*a1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 - \
            1j*s1z(k0,sx,sy,ep1)*((b1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (b1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1) + 1j*s1z(k0,sx,sy,ep1)*((bb1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (bb1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)

def q4TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L14TM + Y4TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#--F2
def Y4TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (-1j*(b1HVF2(k0,thi,phi,th,ph,ep1,ep2,d) + bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d))*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 - 1j*s0z(k0,sx,sy)*((a1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)) + (a1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy)) + (1j*a1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 - \
            1j*s1z(k0,sx,sy,ep1)*((b1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (b1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1) + 1j*s1z(k0,sx,sy,ep1)*((bb1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)

def q4TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L14TM + Y4TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#-----

def L15TM(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (kir(k0,thi)*(ky(k0,th,ph) - sy)*(-(c0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*k0*k2zi(k0,thi,ep2)*sqrt(ep1)) + b0VV(k0,thi,ep1,ep2,d)*exp(2*1j*d*k1zi(k0,thi,ep1))*k0*k1zi(k0,thi,ep1)*sqrt(ep2) - bb0VV(k0,thi,ep1,ep2,d)*k0*k1zi(k0,thi,ep1)*sqrt(ep2)))/(exp(1j*d*k1zi(k0,thi,ep1))*k0**2*sqrt(ep1)*sqrt(ep2))

#--F1
def Y5TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (b1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1))) - (1j*s1z(k0,sx,sy,ep1)*((bb1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (bb1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1))))/exp(1j*d*s1z(k0,sx,sy,ep1))+\
            (1j*(bb1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (c1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sy)/(k0*sr(sx,sy)*sqrt(ep2)))-\
            (1j*c1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep2))

def q5TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L15TM(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y5TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)


#--F2
def Y5TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (b1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1))) - (1j*s1z(k0,sx,sy,ep1)*((bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (bb1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1))))/exp(1j*d*s1z(k0,sx,sy,ep1))+\
            (1j*(bb1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (c1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sy)/(k0*sr(sx,sy)*sqrt(ep2)))-\
            (1j*c1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(ky(k0,th,ph) - sy)*sr(sx,sy))/(k0*sqrt(ep2))

def q5TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L15TM(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y5TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#----

def L16TM(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (kir(k0,thi)*(kx(k0,th,ph) - sx)*(c0VV(k0,thi,ep1,ep2,d)*exp(1j*d*(k1zi(k0,thi,ep1) + k2zi(k0,thi,ep2)))*k0*k2zi(k0,thi,ep2)*sqrt(ep1) - b0VV(k0,thi,ep1,ep2,d)*exp(2*1j*d*k1zi(k0,thi,ep1))*k0*k1zi(k0,thi,ep1)*sqrt(ep2) + bb0VV(k0,thi,ep1,ep2,d)*k0*k1zi(k0,thi,ep1)*sqrt(ep2)))/(exp(1j*d*k1zi(k0,thi,ep1))*k0**2*sqrt(ep1)*sqrt(ep2))

#--F1
def Y6TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return  1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (b1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1))) - (1j*s1z(k0,sx,sy,ep1)*((bb1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (bb1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1))))/exp(1j*d*s1z(k0,sx,sy,ep1))-\
            (1j*(bb1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (c1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sx)/(k0*sr(sx,sy)*sqrt(ep2)))+\
            (1j*c1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep2))

def q6TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L16TM(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y6TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#--F2
def Y6TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (b1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1))) - (1j*s1z(k0,sx,sy,ep1)*((bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (bb1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1))))/exp(1j*d*s1z(k0,sx,sy,ep1))-\
            (1j*(bb1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (c1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sx)/(k0*sr(sx,sy)*sqrt(ep2)))+\
            (1j*c1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(kx(k0,th,ph) - sx)*sr(sx,sy))/(k0*sqrt(ep2))


def q6TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L16TM(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + Y6TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#----

L17TM = 0


#--F1
def Y7TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (1j*c1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 - (1j*(bb1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 + 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (b1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)-\
            (1j*s1z(k0,sx,sy,ep1)*((bb1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (bb1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1))/exp(1j*d*s1z(k0,sx,sy,ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (c1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sy)/(k0*sr(sx,sy)*sqrt(ep2)))*sqrt(ep2)

def q7TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L17TM + Y7TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#--F2
def Y7TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (1j*c1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 - (1j*(bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(ky(k0,th,ph) - sy)*sr(sx,sy))/k0 + 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (b1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)-\
            (1j*s1z(k0,sx,sy,ep1)*((bb1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) - (bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sy)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1))/exp(1j*d*s1z(k0,sx,sy,ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sx)/sr(sx,sy) + (c1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sy)/(k0*sr(sx,sy)*sqrt(ep2)))*sqrt(ep2)


def q7TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L17TM + Y7TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#----

L18TM = 0

#--F1
def Y8TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (-1j*c1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 + (1j*(bb1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 + 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (b1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)-\
            (1j*s1z(k0,sx,sy,ep1)*((bb1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (bb1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1))/exp(1j*d*s1z(k0,sx,sy,ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (c1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sx)/(k0*sr(sx,sy)*sqrt(ep2)))*sqrt(ep2) 

def q8TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L18TM + Y8TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

#--F2
def Y8TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (-1j*c1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s2z(k0,sx,sy,ep2))*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 + (1j*(bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)/exp(1j*d*s1z(k0,sx,sy,ep1)) + b1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*exp(1j*d*s1z(k0,sx,sy,ep1)))*(kx(k0,th,ph) - sx)*sr(sx,sy))/k0 + 1j*exp(1j*d*s1z(k0,sx,sy,ep1))*s1z(k0,sx,sy,ep1)*((b1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (b1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1)-\
            (1j*s1z(k0,sx,sy,ep1)*((bb1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) + (bb1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s1z(k0,sx,sy,ep1)*sx)/(k0*sr(sx,sy)*sqrt(ep1)))*sqrt(ep1))/exp(1j*d*s1z(k0,sx,sy,ep1)) - 1j*exp(1j*d*s2z(k0,sx,sy,ep2))*s2z(k0,sx,sy,ep2)*((c1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)*sy)/sr(sx,sy) - (c1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)*s2z(k0,sx,sy,ep2)*sx)/(k0*sr(sx,sy)*sqrt(ep2)))*sqrt(ep2) 

def q8TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return L18TM + Y8TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)

"""<h2> Secci√≥n Eficaz </h2>
<br>

**A orden uno es la ecuaci√≥n (27) del paper de Moghaddam:
falta escribir bien la correlaci√≥n entre f1 y f2 - que yo puse gaussiana**
"""

## Espectro de potencias de la superficie ##
# gaussiana
def w(s,l,k1,k2,acf):

  if(acf==1):
    # gaussiana
    return s**2*l**2/(4*np.pi)*np.exp(-0.25*l**2*(k1**2+k2**2))

  if(acf==2):
    # exponencial
    return s**2*l**2/(2*np.pi*(1+(k1**2+k2**2)*l**2)**(3/2))

  if(acf==3):
    # power law
    return s**2*l**2/(2*np.pi)*np.exp(-np.sqrt(k1**2+k2**2)*l)
  
  else:
    print('ACF invalida')


def w_12(s1,l1,s2,l2,k1,k2):
    return 0

"""<h3> Orden uno </h3>"""

# CANAL HH #
def SO1HH(k0,thi,phi,th,ph,ep1,ep2,d,s1,l1,s2,l2,k1,k2,acf):
    return 4*np.pi*k0**2*cos(th)**2*(abs(a1HHF1(k0,thi,phi,th,ph,ep1,ep2,d))**2*w(s1,l1,k1,k2,acf)+\
            abs(a1HHF2(k0,thi,phi,th,ph,ep1,ep2,d))**2*w(s2,l2,k1,k2,acf)+\
            2*real(a1HHF1(k0,thi,phi,th,ph,ep1,ep2,d)*conj(a1HHF2(k0,thi,phi,th,ph,ep1,ep2,d)))*w_12(s1,l1,s2,l2,k1,k2))
# CANAL VH #
def SO1VH(k0,thi,phi,th,ph,ep1,ep2,d,s1,l1,s2,l2,k1,k2,acf):
    return 4*np.pi*k0**2*cos(th)**2*(abs(a1VHF1(k0,thi,phi,th,ph,ep1,ep2,d))**2*w(s1,l1,k1,k2,acf)+\
            abs(a1VHF2(k0,thi,phi,th,ph,ep1,ep2,d))**2*w(s2,l2,k1,k2,acf)+\
            2*real(a1VHF1(k0,thi,phi,th,ph,ep1,ep2,d)*conj(a1VHF2(k0,thi,phi,th,ph,ep1,ep2,d)))*w_12(s1,l1,s2,l2,k1,k2))

# CANAL VV #
def SO1VV(k0,thi,phi,th,ph,ep1,ep2,d,s1,l1,s2,l2,k1,k2,acf):
    return 4*np.pi*k0**2*cos(th)**2*(abs(a1VVF1(k0,thi,phi,th,ph,ep1,ep2,d))**2*w(s1,l1,k1,k2,acf)+\
            abs(a1VVF2(k0,thi,phi,th,ph,ep1,ep2,d))**2*w(s2,l2,k1,k2,acf)+\
            2*real(a1VVF1(k0,thi,phi,th,ph,ep1,ep2,d)*conj(a1VVF2(k0,thi,phi,th,ph,ep1,ep2,d)))*w_12(s1,l1,s2,l2,k1,k2))

# CANAL HV #
def SO1HV(k0,thi,phi,th,ph,ep1,ep2,d,s1,l1,s2,l2,k1,k2,acf):
    return 4*np.pi*k0**2*cos(th)**2*(abs(a1HVF1(k0,thi,phi,th,ph,ep1,ep2,d))**2*w(s1,l1,k1,k2,acf)+\
            abs(a1HVF2(k0,thi,phi,th,ph,ep1,ep2,d))**2*w(s2,l2,k1,k2,acf)+\
            2*real(a1HVF1(k0,thi,phi,th,ph,ep1,ep2,d)*conj(a1HVF2(k0,thi,phi,th,ph,ep1,ep2,d)))*w_12(s1,l1,s2,l2,k1,k2))

"""<h3> Orden dos </h3>
<br>

*falta integrar en [sx;sy] en (-Inf;Inf)*
"""

#Canal HH 

def L0_11HH(k0,th,ph,thi,phi,ep1,ep2,d):
    return -(kr(k0,th)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1)-k2z(k0,th,ep2))*(k1z(k0,th,ep1)*(kx(k0,th,ph)*L01TE(k0,thi,phi,ep1,ep2,d)+ky(k0,th,ph)*L02TE(k0,thi,phi,ep1,ep2,d))+\
            k0*(ky(k0,th,ph)*L03TE(k0,thi,phi,ep1,ep2,d)-kx(k0,th,ph)*L04TE(k0,thi,phi,ep1,ep2,d)))+(-k1z(k0,th,ep1)-k2z(k0,th,ep2))*(k1z(k0,th,ep1)*(kx(k0,th,ph)*L01TE(k0,thi,phi,ep1,ep2,d)+\
            ky(k0,th,ph)*L02TE(k0,thi,phi,ep1,ep2,d))+k0*(-ky(k0,th,ph)*L03TE(k0,thi,phi,ep1,ep2,d)+kx(k0,th,ph)*L04TE(k0,thi,phi,ep1,ep2,d)))))/\
            ((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th)-k1z(k0,th,ep1))*(k1z(k0,th,ep1)-k2z(k0,th,ep2))+(k0z(k0,th)+k1z(k0,th,ep1))*(k1z(k0,th,ep1)+k2z(k0,th,ep2)))*(kr(k0,th)**2))

def L0_22HH(k0,th,ph,thi,phi,ep1,ep2,d):
    return (2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*kr(k0,th)* (k2z(k0,th,ep2)*(kx(k0,th,ph)*L05TE(k0,thi,phi,ep1,ep2,d)+ ky(k0,th,ph)* L06TE(k0,thi,phi,ep1,ep2,d))+\
            k0*(-ky(k0,th,ph)*L07TE(k0,thi,phi,ep1,ep2,d)+kx(k0,th,ph)*L08TE(k0,thi,phi,ep1,ep2,d))))/\
            ((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th)-k1z(k0,th,ep1))*(k1z(k0,th,ep1)- k2z(k0,th,ep2))+(k0z(k0,th)+k1z(k0,th,ep1))*(k1z(k0,th,ep1)+k2z(k0,th,ep2)))* (kr(k0,th)**2))


def L1_11HH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -(kr(k0,th)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1)-k2z(k0,th,ep2))*(k1z(k0,th,ep1)*(kx(k0,th,ph)*q1TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+ ky(k0,th,ph)*q2TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k0*(ky(k0,th,ph)*q3TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) - kx(k0,th,ph)*q4TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) ))+\
            (-k1z(k0,th,ep1) - k2z(k0,th,ep2))*(k1z(k0,th,ep1)*(kx(k0,th,ph)*q1TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+ ky(k0,th,ph)*q2TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k0*(-(ky(k0,th,ph)*q3TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + kx(k0,th,ph)*q4TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)))))/\
            ((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*(kr(k0,th)**2)) 

 
def L1_22HH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*kr(k0,th)*(k2z(k0,th,ep2)*(kx(k0,th,ph)*q5TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*q6TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k0*(-(ky(k0,th,ph)*q7TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + kx(k0,th,ph)*q8TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))))/\
            ((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*(kr(k0,th)**2))



def L1_12HH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -((kr(k0,th)*((-k1z(k0,th,ep1) - k2z(k0,th,ep2))*(k1z(k0,th,ep1)*kx(k0,th,ph)*q1TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)\
            + k1z(k0,th,ep1)*ky(k0,th,ph)*q2TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)-k0*ky(k0,th,ph)*q3TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
            k0*kx(k0,th,ph)*q4TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))+exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1)-k2z(k0,th,ep2))*(k1z(k0,th,ep1)*kx(k0,th,ph)*q1TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
            k1z(k0,th,ep1)*ky(k0,th,ph)*q2TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + k0*(ky(k0,th,ph)*q3TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) - kx(k0,th,ph)*q4TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)))-\
             2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*(k2z(k0,th,ep2)*kx(k0,th,ph)*q5TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + k2z(k0,th,ep1)*ky(k0,th,ph)*q6TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) - k0*ky(k0,th,ph)*q7TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
             k0*kx(k0,th,ph)*q8TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))))/((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)))

def SO2HH(args):
    sx,sy,k0,th,ph,thi,phi,ep1,ep2,d,s1,l1,s2,l2,acf = args
    return 4*np.pi*k0**2*cos(th)**2*\
            (w(s1,l1,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy,acf)*w(s1,l1,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi),acf)*\
            (2*abs(L0_11HH(k0,th,ph,thi,phi,ep1,ep2,d))**2+abs(L1_11HH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2+\
            2*real(L0_11HH(k0,th,ph,thi,phi,ep1,ep2,d)*conj(L1_11HH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
            L1_11HH(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            L1_11HH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*\
            conj(L1_11HH(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            w(s2,l2,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy,acf)*w(s2,l2,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi),acf)*\
            (2*abs(L0_22HH(k0,th,ph,thi,phi,ep1,ep2,d))**2+abs(L1_22HH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2+\
            2*real(L0_22HH(k0,th,ph,thi,phi,ep1,ep2,d)*conj(L1_22HH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
            L1_22HH(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            L1_22HH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*\
            conj(L1_22HH(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            w(s1,l1,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy,acf)*w(s2,l2,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi),acf)*abs(L1_12HH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2)

# #Canal VH

# def L0_11VH(k0,th,ph,thi,phi,ep1,ep2,d):
#     return kr(k0,th)*(-((k2z(k0,th,ep2)*ep1+k1z(k0,th,ep1)*ep2)*(k0*ep1*(ky(k0,th,ph)*L01TE(k0,thi,phi,ep1,ep2,d)- kx(k0,th,ph)*L02TE(k0,thi,phi,ep1,ep2,d))+k1z(k0,th,ep1)*(kx(k0,th,ph)*L03TE(k0,thi,phi,ep1,ep2,d)+ky(k0,th,ph)*L04TE(k0,thi,phi,ep1,ep2,d))))+\
#            exp(2*1j*d*k1z(k0,th,ep1))*(-(k2z(k0,th,ep2)*ep1)+k1z(k0,th,ep1)*ep2)*(k0*ep1*(-(ky(k0,th,ph)*L01TE(k0,thi,phi,ep1,ep2,d))+kx(k0,th,ph)*L02TE(k0,thi,phi,ep1,ep2,d)+k1z(k0,th,ep1)*(kx(k0,th,ph)*L03TE(k0,thi,phi,ep1,ep2,d)+ky(k0,th,ph)*L04TE(k0,thi,phi,ep1,ep2,d)))))/\
#            ((kr(k0,th)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1)-k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1)+k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2))) 

# def L0_22VH(k0,th,ph,thi,phi,ep1,ep2,d):
#     return -(2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*kr(k0,th)*ep1*(k0*ep2*(ky(k0,th,ph)*L05TE(k0,thi,phi,ep1,ep2,d)- kx(k0,th,ph)*L06TE(k0,thi,phi,ep1,ep2,d))+k2z(k0,th,ep2)*(kx(k0,th,ph)*L07TE(k0,thi,phi,ep1,ep2,d)+ky(k0,th,ph)*L08TE(k0,thi,phi,ep1,ep2,d))))/\
#             ((kr(k0,th)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))


# def L1_11VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
#     return (kr(k0,th)*(-((k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)*(k0*ep1*(ky(k0,th,ph)*q1TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) - kx(k0,th,ph)*q2TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k1z(k0,th,ep1)*(kx(k0,th,ph)*q3TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*q4TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))))+\
#             exp(2*1j*d*k1z(k0,th,ep1))*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2)*(k0*ep1*(-ky(k0,th,ph)*q1TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+ kx(k0,th,ph)*q2TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k1z(k0,th,ep1)*(kx(k0,th,ph)*q3TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*q4TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)))))/\
#             ((kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2)-(k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

# def L1_22VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
#     return (2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*kr(k0,th)*ep1*(k0*ep2*(ky(k0,th,ph)*q5TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)- kx(k0,th,ph)*q6TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k2z(k0,th,ep2)*(kx(k0,th,ph)*q7TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+ ky(k0,th,ph)*q8TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))))/\
#             ((kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))


# def SO2VH(args):
#     sx,sy,k0,th,ph,thi,phi,ep1,ep2,d,s1,l1,s2,l2 = args
#     return 4*np.pi*k0**2*cos(th)**2*\
#             (w(s1,l1,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy)*w(s1,l1,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi))*\
#             (2*abs(L0_11VH(k0,th,ph,thi,phi,ep1,ep2,d))**2+abs(L1_11VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2+\
#             2*real(L0_11VH(k0,th,ph,thi,phi,ep1,ep2,d)*conj(L1_11VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
#             L1_11VH(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
#             L1_11VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*\
#             conj(L1_11VH(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
#             w(s2,l2,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy)*w(s2,l2,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi))*\
#             (2*abs(L0_22VH(k0,th,ph,thi,phi,ep1,ep2,d))**2+abs(L1_22VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2+\
#             2*real(L0_22VH(k0,th,ph,thi,phi,ep1,ep2,d)*conj(L1_22VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
#             L1_22VH(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
#             L1_22VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*\
#             conj(L1_22VH(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d))))


# Canal VH
def L0_11VH(k0,th,ph,thi,phi,ep1,ep2,d):
    return (kr(k0,th)*(-((k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)*(k0*ep1*(ky(k0,th,ph)*L01TE(k0,thi,phi,ep1,ep2,d) - kx(k0,th,ph)*L02TE(k0,thi,phi,ep1,ep2,d)) + k1z(k0,th,ep1)*(kx(k0,th,ph)*L03TE(k0,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*L04TE(k0,thi,phi,ep1,ep2,d))))+\
            exp(2*1j*d*k1z(k0,th,ep1))*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2)*(k0*ep1*(-(ky(k0,th,ph)*L01TE(k0,thi,phi,ep1,ep2,d)) + kx(k0,th,ph)*L02TE(k0,thi,phi,ep1,ep2,d)) + k1z(k0,th,ep1)*(kx(k0,th,ph)*L03TE(k0,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*L04TE(k0,thi,phi,ep1,ep2,d)))))/\
            ((kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

def L1_11VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return  (kr(k0,th)*(-((k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)*(k0*ep1*(ky(k0,th,ph)*q1TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)- kx(k0,th,ph)*q2TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k1z(k0,th,ep1)*(kx(k0,th,ph)*q3TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*q4TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)))) + \
            exp(2*1j*d*k1z(k0,th,ep1))*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2)*(k0*ep1*(-(ky(k0,th,ph)*q1TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + kx(k0,th,ph)*q2TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k1z(k0,th,ep1)*(kx(k0,th,ph)*q3TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*q4TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)))))/\
            ((kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

def L0_22VH(k0,th,ph,thi,phi,ep1,ep2,d):
    return  -(2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*kr(k0,th)*ep1*(k0*ep2*(ky(k0,th,ph)*L05TE(k0,thi,phi,ep1,ep2,d) - kx(k0,th,ph)*L06TE(k0,thi,phi,ep1,ep2,d)) + k2z(k0,th,ep2)*(kx(k0,th,ph)*L07TE(k0,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*L08TE(k0,thi,phi,ep1,ep2,d))))/\
            ((kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

def L1_22VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return  -(2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*kr(k0,th)*ep1*(k0*ep2*(ky(k0,th,ph)*q5TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) - kx(k0,th,ph)*q6TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k2z(k0,th,ep2)*(kx(k0,th,ph)*q7TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+ ky(k0,th,ph)*q8TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))))/\
            ((kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

def L1_12VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (kr(k0,th)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1)*kx(k0,th,ph)*q3TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + k1z(k0,th,ep1)*ky(k0,th,ph)*q4TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)- k0*ky(k0,th,ph)*q1TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*ep1 + k0*kx(k0,th,ph)*q2TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*ep1)*\
            (-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) + (-(k1z(k0,th,ep1)*kx(k0,th,ph)*q3TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) - k1z(k0,th,ep1)*ky(k0,th,ph)*q4TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)-\
            k0*ky(k0,th,ph)*q1TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*ep1 + k0*kx(k0,th,ph)*q2TE_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2) -2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*ep1*(k2z(k0,th,ep2)*kx(k0,th,ph)*q7TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
            k2z(k0,th,ep2)*ky(k0,th,ph)*q8TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + k0*ky(k0,th,ph)*q5TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*ep2 - k0*kx(k0,th,ph)*q6TE_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*ep2)))/\
            ((kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))



def SO2VH(args):
    sx,sy,k0,th,ph,thi,phi,ep1,ep2,d,s1,l1,s2,l2,acf = args
    return 4*np.pi*k0**2*cos(th)**2*\
            (w(s1,l1,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy,acf)*w(s1,l1,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi),acf)*\
            (2*abs(L0_11VH(k0,th,ph,thi,phi,ep1,ep2,d))**2+abs(L1_11VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2+\
            2*real(L0_11VH(k0,th,ph,thi,phi,ep1,ep2,d)*conj(L1_11VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
            L1_11VH(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            L1_11VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*\
            conj(L1_11VH(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            w(s2,l2,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy,acf)*w(s2,l2,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi),acf)*\
            (2*abs(L0_22VH(k0,th,ph,thi,phi,ep1,ep2,d))**2+abs(L1_22VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2+\
            2*real(L0_22VH(k0,th,ph,thi,phi,ep1,ep2,d)*conj(L1_22VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
            L1_22VH(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            L1_22VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*\
            conj(L1_22VH(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            w(s1,l1,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy,acf)*w(s2,l2,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi),acf)*abs(L1_12VH(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2)

#Canal VV

def L0_11VV(k0,th,ph,thi,phi,ep1,ep2,d):
    return (kr(k0,th)*(-((k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)*(k0*ep1*(ky(k0,th,ph)*L01TM(k0,thi,phi,ep1,ep2,d) - kx(k0,th,ph)*L02TM(k0,thi,phi,ep1,ep2,d)) + k1z(k0,th,ep1)*(kx(k0,th,ph)*L03TM(k0,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*L04TM(k0,thi,phi,ep1,ep2,d))))+\
            exp(2*1j*d*k1z(k0,th,ep1))*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2)*(k0*ep1*(-(ky(k0,th,ph)*L01TM(k0,thi,phi,ep1,ep2,d)) + kx(k0,th,ph)*L02TM(k0,thi,phi,ep1,ep2,d)) + k1z(k0,th,ep1)*(kx(k0,th,ph)*L03TM(k0,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*L04TM(k0,thi,phi,ep1,ep2,d)))))/\
            ((kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

def L1_11VV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return  (kr(k0,th)*(-((k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)*(k0*ep1*(ky(k0,th,ph)*q1TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)- kx(k0,th,ph)*q2TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k1z(k0,th,ep1)*(kx(k0,th,ph)*q3TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*q4TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)))) + \
            exp(2*1j*d*k1z(k0,th,ep1))*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2)*(k0*ep1*(-(ky(k0,th,ph)*q1TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + kx(k0,th,ph)*q2TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k1z(k0,th,ep1)*(kx(k0,th,ph)*q3TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*q4TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)))))/\
            ((kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

def L0_22VV(k0,th,ph,thi,phi,ep1,ep2,d):
    return  -(2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*kr(k0,th)*ep1*(k0*ep2*(ky(k0,th,ph)*L05TM(k0,thi,phi,ep1,ep2,d) - kx(k0,th,ph)*L06TM(k0,thi,phi,ep1,ep2,d)) + k2z(k0,th,ep2)*(kx(k0,th,ph)*L07TM(k0,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*L08TM(k0,thi,phi,ep1,ep2,d))))/\
            ((kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

def L1_22VV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return  -(2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*kr(k0,th)*ep1*(k0*ep2*(ky(k0,th,ph)*q5TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) - kx(k0,th,ph)*q6TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k2z(k0,th,ep2)*(kx(k0,th,ph)*q7TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+ ky(k0,th,ph)*q8TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))))/\
            ((kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))

def L1_12VV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (kr(k0,th)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1)*kx(k0,th,ph)*q3TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + k1z(k0,th,ep1)*ky(k0,th,ph)*q4TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)- k0*ky(k0,th,ph)*q1TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*ep1 + k0*kx(k0,th,ph)*q2TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*ep1)*\
            (-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) + (-(k1z(k0,th,ep1)*kx(k0,th,ph)*q3TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) - k1z(k0,th,ep1)*ky(k0,th,ph)*q4TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)-\
            k0*ky(k0,th,ph)*q1TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*ep1 + k0*kx(k0,th,ph)*q2TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2) -2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*ep1*(k2z(k0,th,ep2)*kx(k0,th,ph)*q7TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
            k2z(k0,th,ep2)*ky(k0,th,ph)*q8TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + k0*ky(k0,th,ph)*q5TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*ep2 - k0*kx(k0,th,ph)*q6TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*ep2)))/\
            ((kx(k0,th,ph)**2 + ky(k0,th,ph)**2)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k0z(k0,th)*ep1)*(-(k2z(k0,th,ep2)*ep1) + k1z(k0,th,ep1)*ep2) - (k1z(k0,th,ep1) + k0z(k0,th)*ep1)*(k2z(k0,th,ep2)*ep1 + k1z(k0,th,ep1)*ep2)))



def SO2VV(args):
    sx,sy,k0,th,ph,thi,phi,ep1,ep2,d,s1,l1,s2,l2,acf = args
    return 4*np.pi*k0**2*cos(th)**2*\
            (w(s1,l1,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy,acf)*w(s1,l1,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi),acf)*\
            (2*abs(L0_11VV(k0,th,ph,thi,phi,ep1,ep2,d))**2+abs(L1_11VV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2+\
            2*real(L0_11VV(k0,th,ph,thi,phi,ep1,ep2,d)*conj(L1_11VV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
            0*L1_11VV(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            L1_11VV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*\
            conj(L1_11VV(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            w(s2,l2,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy,acf)*w(s2,l2,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi),acf)*\
            (2*abs(L0_22VV(k0,th,ph,thi,phi,ep1,ep2,d))**2+abs(L1_22VV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2+\
            2*real(L0_22VV(k0,th,ph,thi,phi,ep1,ep2,d)*conj(L1_22VV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
            L1_22VV(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            L1_22VV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*\
            conj(L1_22VV(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            w(s1,l1,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy,acf)*w(s2,l2,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi),acf)*abs(L1_12VV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2)

#Canal HV 

# def L0_11HV(k0,th,ph,thi,phi,ep1,ep2,d):
#     return -(kr(k0,th)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1)-k2z(k0,th,ep2))*(k1z(k0,th,ep1)*(kx(k0,th,ph)*L01TM(k0,thi,phi,ep1,ep2,d)+ky(k0,th,ph)*L02TM(k0,thi,phi,ep1,ep2,d))+\
#             k0*(ky(k0,th,ph)*L03TM(k0,thi,phi,ep1,ep2,d)-kx(k0,th,ph)*L04TM(k0,thi,phi,ep1,ep2,d)))+(-k1z(k0,th,ep1)-k2z(k0,th,ep2))*(k1z(k0,th,ep1)*(kx(k0,th,ph)*L01TM(k0,thi,phi,ep1,ep2,d)+\
#             ky(k0,th,ph)*L02TM(k0,thi,phi,ep1,ep2,d))+k0*(-ky(k0,th,ph)*L03TM(k0,thi,phi,ep1,ep2,d)+kx(k0,th,ph)*L04TM(k0,thi,phi,ep1,ep2,d)))))/\
#             ((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th)-k1z(k0,th,ep1))*(k1z(k0,th,ep1)-k2z(k0,th,ep2))+(k0z(k0,th)+k1z(k0,th,ep1))*(k1z(k0,th,ep1)+k2z(k0,th,ep2)))*(kr(k0,th)**2))

# def L0_22HV(k0,th,ph,thi,phi,ep1,ep2,d):
#     return (2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*kr(k0,th)* (k2z(k0,th,ep2)*(kx(k0,th,ph)*L05TM(k0,thi,phi,ep1,ep2,d)+ ky(k0,th,ph)* L06TM(k0,thi,phi,ep1,ep2,d))+\
#             k0*(-ky(k0,th,ph)*L07TM(k0,thi,phi,ep1,ep2,d)+kx(k0,th,ph)*L08TM(k0,thi,phi,ep1,ep2,d))))/\
#             ((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th)-k1z(k0,th,ep1))*(k1z(k0,th,ep1)- k2z(k0,th,ep2))+(k0z(k0,th)+k1z(k0,th,ep1))*(k1z(k0,th,ep1)+k2z(k0,th,ep2)))* (kr(k0,th)**2))


# def L1_11HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
#     return -(kr(k0,th)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1)-k2z(k0,th,ep2))*(k1z(k0,th,ep1)*(kx(k0,th,ph)*q1TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+ ky(k0,th,ph)*q2TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k0*(ky(k0,th,ph)*q3TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) - kx(k0,th,ph)*q4TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) ))+\
#             (-k1z(k0,th,ep1) - k2z(k0,th,ep2))*(k1z(k0,th,ep1)*(kx(k0,th,ph)*q1TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+ ky(k0,th,ph)*q2TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k0*(-(ky(k0,th,ph)*q3TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + kx(k0,th,ph)*q4TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)))))/\
#             ((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*(kr(k0,th)**2)) 

 
# def L1_22HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
#     return (2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*kr(k0,th)*(k2z(k0,th,ep2)*(kx(k0,th,ph)*q5TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*q6TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k0*(-(ky(k0,th,ph)*q7TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + kx(k0,th,ph)*q8TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))))/\
#             ((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*(kr(k0,th)**2))


# def SO2HV(args):
#     sx,sy,k0,th,ph,thi,phi,ep1,ep2,d,s1,l1,s2,l2 = args
#     return 4*np.pi*k0**2*cos(th)**2*\
#             (w(s1,l1,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy)*w(s1,l1,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi))*\
#             (2*abs(L0_11HV(k0,th,ph,thi,phi,ep1,ep2,d))**2+abs(L1_11HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2+\
#             2*real(L0_11HV(k0,th,ph,thi,phi,ep1,ep2,d)*conj(L1_11HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
#             L1_11HV(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
#             L1_11HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*\
#             conj(L1_11HV(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
#             w(s2,l2,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy)*w(s2,l2,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi))*\
#             (2*abs(L0_22HV(k0,th,ph,thi,phi,ep1,ep2,d))**2+abs(L1_22HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2+\
#             2*real(L0_22HV(k0,th,ph,thi,phi,ep1,ep2,d)*conj(L1_22HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
#             L1_22HV(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
#             L1_22HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*\
#             conj(L1_22HV(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d))))

def L0_11HV(k0,th,ph,thi,phi,ep1,ep2,d):
    return -(kr(k0,th)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1)-k2z(k0,th,ep2))*(k1z(k0,th,ep1)*(kx(k0,th,ph)*L01TM(k0,thi,phi,ep1,ep2,d)+ky(k0,th,ph)*L02TM(k0,thi,phi,ep1,ep2,d))+\
            k0*(ky(k0,th,ph)*L03TM(k0,thi,phi,ep1,ep2,d)-kx(k0,th,ph)*L04TM(k0,thi,phi,ep1,ep2,d)))+(-k1z(k0,th,ep1)-k2z(k0,th,ep2))*(k1z(k0,th,ep1)*(kx(k0,th,ph)*L01TM(k0,thi,phi,ep1,ep2,d)+\
            ky(k0,th,ph)*L02TM(k0,thi,phi,ep1,ep2,d))+k0*(-ky(k0,th,ph)*L03TM(k0,thi,phi,ep1,ep2,d)+kx(k0,th,ph)*L04TM(k0,thi,phi,ep1,ep2,d)))))/\
            ((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th)-k1z(k0,th,ep1))*(k1z(k0,th,ep1)-k2z(k0,th,ep2))+(k0z(k0,th)+k1z(k0,th,ep1))*(k1z(k0,th,ep1)+k2z(k0,th,ep2)))*(kr(k0,th)**2))

def L0_22HV(k0,th,ph,thi,phi,ep1,ep2,d):
    return (2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*kr(k0,th)* (k2z(k0,th,ep2)*(kx(k0,th,ph)*L05TM(k0,thi,phi,ep1,ep2,d)+ ky(k0,th,ph)* L06TM(k0,thi,phi,ep1,ep2,d))+\
            k0*(-ky(k0,th,ph)*L07TM(k0,thi,phi,ep1,ep2,d)+kx(k0,th,ph)*L08TM(k0,thi,phi,ep1,ep2,d))))/\
            ((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th)-k1z(k0,th,ep1))*(k1z(k0,th,ep1)- k2z(k0,th,ep2))+(k0z(k0,th)+k1z(k0,th,ep1))*(k1z(k0,th,ep1)+k2z(k0,th,ep2)))* (kr(k0,th)**2))


def L1_11HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -(kr(k0,th)*(exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1)-k2z(k0,th,ep2))*(k1z(k0,th,ep1)*(kx(k0,th,ph)*q1TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+ ky(k0,th,ph)*q2TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k0*(ky(k0,th,ph)*q3TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) - kx(k0,th,ph)*q4TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) ))+\
            (-k1z(k0,th,ep1) - k2z(k0,th,ep2))*(k1z(k0,th,ep1)*(kx(k0,th,ph)*q1TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+ ky(k0,th,ph)*q2TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k0*(-(ky(k0,th,ph)*q3TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + kx(k0,th,ph)*q4TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)))))/\
            ((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*(kr(k0,th)**2)) 

 
def L1_22HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return (2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*kr(k0,th)*(k2z(k0,th,ep2)*(kx(k0,th,ph)*q5TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + ky(k0,th,ph)*q6TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + k0*(-(ky(k0,th,ph)*q7TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)) + kx(k0,th,ph)*q8TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))))/\
            ((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*(kr(k0,th)**2))



def L1_12HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d):
    return -((kr(k0,th)*((-k1z(k0,th,ep1) - k2z(k0,th,ep2))*(k1z(k0,th,ep1)*kx(k0,th,ph)*q1TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)\
            + k1z(k0,th,ep1)*ky(k0,th,ph)*q2TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)-k0*ky(k0,th,ph)*q3TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
            k0*kx(k0,th,ph)*q4TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))+exp(2*1j*d*k1z(k0,th,ep1))*(k1z(k0,th,ep1)-k2z(k0,th,ep2))*(k1z(k0,th,ep1)*kx(k0,th,ph)*q1TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
            k1z(k0,th,ep1)*ky(k0,th,ph)*q2TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + k0*(ky(k0,th,ph)*q3TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) - kx(k0,th,ph)*q4TM_F2(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)))-\
             2*exp(1j*d*k1z(k0,th,ep1))*k1z(k0,th,ep1)*(k2z(k0,th,ep2)*kx(k0,th,ph)*q5TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) + k2z(k0,th,ep1)*ky(k0,th,ph)*q6TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d) - k0*ky(k0,th,ph)*q7TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
             k0*kx(k0,th,ph)*q8TM_F1(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))))/((exp(2*1j*d*k1z(k0,th,ep1))*(k0z(k0,th) - k1z(k0,th,ep1))*(k1z(k0,th,ep1) - k2z(k0,th,ep2)) + (k0z(k0,th) + k1z(k0,th,ep1))*(k1z(k0,th,ep1) + k2z(k0,th,ep2)))*(kx(k0,th,ph)**2 + ky(k0,th,ph)**2)))

def SO2HV(args):
    sx,sy,k0,th,ph,thi,phi,ep1,ep2,d,s1,l1,s2,l2,acf = args
    return 4*np.pi*k0**2*cos(th)**2*\
            (w(s1,l1,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy,acf)*w(s1,l1,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi),acf)*\
            (2*abs(L0_11HV(k0,th,ph,thi,phi,ep1,ep2,d))**2+abs(L1_11HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2+\
            2*real(L0_11HV(k0,th,ph,thi,phi,ep1,ep2,d)*conj(L1_11HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
            L1_11HV(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            L1_11HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*\
            conj(L1_11HV(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            w(s2,l2,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy,acf)*w(s2,l2,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi),acf)*\
            (2*abs(L0_22HV(k0,th,ph,thi,phi,ep1,ep2,d))**2+abs(L1_22HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2+\
            2*real(L0_22HV(k0,th,ph,thi,phi,ep1,ep2,d)*conj(L1_22HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)+\
            L1_22HV(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            L1_22HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d)*\
            conj(L1_22HV(kx(k0,th,ph)+kix(k0,thi,phi)-sx,ky(k0,th,ph)+kiy(k0,thi,phi)-sy,k0,th,ph,thi,phi,ep1,ep2,d)))+\
            w(s1,l1,kx(k0,th,ph)-sx,ky(k0,th,ph)-sy,acf)*w(s2,l2,sx-kix(k0,thi,phi),sy-kiy(k0,thi,phi),acf)*abs(L1_12HV(sx,sy,k0,th,ph,thi,phi,ep1,ep2,d))**2)